<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šå‰é†«ç™‚-è—¥å“é†«æè«‹è³¼ç³»çµ±</title>
    <!-- å¼•å…¥SheetJSåº«ç”¨æ–¼Excelè§£æ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ç™»å…¥é é¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-form h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* ä¸»ç³»çµ±ä»‹é¢ */
        .main-system {
            display: none;
        }

        .header {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #ff3742;
        }

        .nav-menu {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            position: relative;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #2f3542, #40407a);
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .form-col label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-col input,
        .form-col select,
        .form-col textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-col textarea {
            height: 80px;
            resize: vertical;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-secondary {
            background: #57606f;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* å“é …è¡¨æ ¼ */
        .items-table {
            margin-top: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .items-table th {
            background: #667eea;
            color: white;
        }

        /* ä¸‹æ‹‰é¸å–® */
        .dropdown {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .dropdown-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.3s;
        }

        .dropdown-content a:hover {
            background: #f1f1f1;
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #ffa726;
            color: white;
        }

        .status-approved {
            background: #66bb6a;
            color: white;
        }

        .status-rejected {
            background: #ef5350;
            color: white;
        }

        /* æœå°‹æ¡† */
        .search-box {
            width: 300px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 25px;
            margin-bottom: 20px;
        }

        /* åº«å­˜ç®¡ç† */
        .inventory-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        /* æª”æ¡ˆä¸Šå‚³ */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        /* å‹¾é¸æ¡†æ¨£å¼ */
        .approved-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            transform: scale(1.2);
        }

        .approved-checkbox:checked {
            accent-color: #667eea;
        }

        /* é¸æ“‡æ“ä½œå€åŸŸ */
        .selection-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .selection-controls h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .nav-buttons {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
            }

            .inventory-stats {
                flex-direction: column;
            }

            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 8px;
            }

            .selection-controls {
                text-align: center;
            }

            .selection-controls .btn {
                margin: 5px;
                width: 100%;
            }
        }

        /* æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .section-divider {
            border-top: 2px solid #eee;
            margin: 30px 0;
            padding-top: 20px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ä¸Šå‚³ç‹€æ…‹æ¨£å¼ */
        .upload-status {
            margin-bottom: 20px;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            padding: 10px;
            border-radius: 5px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-form">
            <h1>ğŸ¥ ä¸Šå‰é†«ç™‚<br>è—¥å“é†«æè«‹è³¼ç³»çµ±</h1>
            <div class="form-group">
                <label for="username">å¸³è™Ÿ</label>
                <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
            </div>
            <div class="form-group">
                <label for="password">å¯†ç¢¼</label>
                <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="login-btn" type="button" onclick="login()">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <!-- ä¸»ç³»çµ± -->
    <div id="mainSystem" class="main-system">
        <div class="container">
            <!-- é ‚éƒ¨æ¨™é¡Œ -->
            <div class="header">
                <h1>ğŸ¥ ä¸Šå‰é†«ç™‚ - è—¥å“é†«æè«‹è³¼ç³»çµ±</h1>
                <div class="user-info">
                    <span>æ­¡è¿ï¼Œ<span id="currentUser"></span></span>
                    <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>

            <!-- å°èˆªé¸å–® -->
            <div class="nav-menu">
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="showPage('newProcurement')">ğŸ“ æ–°å¢è«‹è³¼</button>
                    <button class="nav-btn" onclick="showPage('approvalManagement')" id="approvalBtn">
                        âœ… ç°½æ ¸ç®¡ç†
                        <span class="notification-badge" id="pendingCount" style="display: none;">0</span>
                    </button>
                    <button class="nav-btn" onclick="showPage('approved')">âœ”ï¸ å·²æ ¸å‡†</button>
                    <button class="nav-btn" onclick="showPage('rejected')">ğŸš« å·²é§å›</button>
                    <button class="nav-btn" onclick="showPage('createPurchase')">ğŸ“ å»ºç«‹æ¡è³¼å–®</button>
                    <button class="nav-btn" onclick="showPage('inventory')">ğŸ“¦ åº«å­˜ç®¡ç†</button>
                    <button class="nav-btn" onclick="showPage('systemAdmin')">ğŸ› ï¸ ç³»çµ±ç®¡ç†</button>
                </div>
            </div>

            <!-- å…§å®¹å€åŸŸ -->
            <div class="content-area">
                <!-- æ–°å¢è«‹è³¼é é¢ -->
                <div id="newProcurement" class="page active">
                    <h2>ğŸ“ æ–°å¢è«‹è³¼å–®</h2>
                    <form id="procurementForm">
                        <div class="form-row">
                            <div class="form-col">
                                <label>è«‹è³¼å–®è™Ÿ</label>
                                <input type="text" id="procurementNo" readonly>
                            </div>
                            <div class="form-col">
                                <label>ç”³è«‹æ—¥æœŸ</label>
                                <input type="date" id="applyDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>ç”³è«‹éƒ¨é–€</label>
                                <select id="department">
                                    <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
                                    <option value="å…§ç§‘">å…§ç§‘</option>
                                    <option value="å¤–ç§‘">å¤–ç§‘</option>
                                    <option value="æ€¥è¨ºç§‘">æ€¥è¨ºç§‘</option>
                                    <option value="è—¥åŠ‘ç§‘">è—¥åŠ‘ç§‘</option>
                                    <option value="è­·ç†éƒ¨">è­·ç†éƒ¨</option>
                                    <option value="è¡Œæ”¿éƒ¨">è¡Œæ”¿éƒ¨</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>ç”³è«‹äººå§“å</label>
                                <input type="text" id="applicantName">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>è«‹è³¼äº‹ç”±</label>
                                <textarea id="procurementReason" placeholder="è«‹è©³ç´°èªªæ˜è«‹è³¼äº‹ç”±..."></textarea>
                            </div>
                        </div>
                        
                        <h3>è«‹è³¼å“é …</h3>
                        <button type="button" class="btn btn-primary" onclick="addItem()">â• æ–°å¢å“é …</button>
                        
                        <table class="table items-table" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>é¡åˆ¥</th>
                                    <th>åç¨±</th>
                                    <th>è¦æ ¼</th>
                                    <th>æ•¸é‡</th>
                                    <th>å–®ä½</th>
                                    <th>é ä¼°å–®åƒ¹</th>
                                    <th>å°è¨ˆ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; text-align: right;">
                            <strong>ç¸½é‡‘é¡ï¼šNT$ <span id="totalAmount">0</span></strong>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button type="button" class="btn btn-success" onclick="submitProcurement()">ğŸ“¤ æäº¤è«‹è³¼å–®</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">ğŸ”„ é‡è¨­</button>
                        </div>
                    </form>
                </div>

                <!-- ç°½æ ¸ç®¡ç†é é¢ -->
                <div id="approvalManagement" class="page">
                    <h2>âœ… ç°½æ ¸ç®¡ç†</h2>
                    
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('approvalDropdown')">
                            é¸æ“‡å–®æ“šé¡å‹ â–¼
                        </button>
                        <div class="dropdown-content" id="approvalDropdown">
                            <a href="#" onclick="showApprovalType('procurement')">1. è«‹è³¼å–®</a>
                            <a href="#" onclick="showApprovalType('purchase')">2. æ¡è³¼å–®</a>
                        </div>
                    </div>

                    <div id="procurementApproval" class="section-divider">
                        <h3>å¾…å¯©æ ¸è«‹è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>è«‹è³¼å–®è™Ÿ</th>
                                    <th>ç”³è«‹æ—¥æœŸ</th>
                                    <th>ç”³è«‹éƒ¨é–€</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="pendingProcurementTable">
                                <!-- å‹•æ…‹æ–°å¢çš„è«‹è³¼å–®æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                            </tbody>
                        </table>
                    </div>

                    <div id="purchaseApproval" class="section-divider" style="display: none;">
                        <h3>å¾…å¯©æ ¸æ¡è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ¡è³¼å–®è™Ÿ</th>
                                    <th>æ¡è³¼æ—¥æœŸ</th>
                                    <th>ä¾›æ‡‰å•†</th>
                                    <th>ç¸½é‡‘é¡</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="pendingPurchaseTable">
                                <!-- å‹•æ…‹æ–°å¢çš„æ¡è³¼å–®æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å·²æ ¸å‡†é é¢ -->
                <div id="approved" class="page">
                    <h2>âœ”ï¸ å·²æ ¸å‡†</h2>
                    
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('approvedDropdown')">
                            é¸æ“‡å–®æ“šé¡å‹ â–¼
                        </button>
                        <div class="dropdown-content" id="approvedDropdown">
                            <a href="#" onclick="showApprovedType('procurement')">1. è«‹è³¼å–®</a>
                            <a href="#" onclick="showApprovedType('purchase')">2. æ¡è³¼å–®</a>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="downloadAllApproved()">ğŸ’¾ å…¨éƒ¨ä¸‹è¼‰è«‹è³¼å–®</button>
                    </div>

                    <div id="approvedProcurementSection">
                        <h3>å·²æ ¸å‡†è«‹è³¼å–®</h3>
                        
                        <div class="selection-controls">
                            <h4>ğŸ“ æ‰¹é‡å»ºç«‹æ¡è³¼å–®</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <button class="btn btn-success" onclick="createPurchaseFromSelected()">
                                    ğŸ“ å»ºç«‹æ¡è³¼å–® (<span id="selectedCount">0</span> é …)
                                </button>
                                <button class="btn btn-secondary" onclick="selectAllApproved()">â˜‘ï¸ å…¨é¸</button>
                                <button class="btn btn-secondary" onclick="clearAllApproved()">â˜ æ¸…é™¤</button>
                                <button class="btn btn-primary" onclick="previewSelectedItems()">ğŸ‘ï¸ é è¦½é¸æ“‡</button>
                            </div>
                            <div class="selection-info" id="selectionInfo">
                                è«‹å‹¾é¸è¦å»ºç«‹æ¡è³¼å–®çš„è«‹è³¼é …ç›®ï¼Œå¯ä»¥å¤šé¸
                            </div>
                        </div>
                        
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllApproved()" style="transform: scale(1.2);">
                                        <br><small>å…¨é¸</small>
                                    </th>
                                    <th>è«‹è³¼å–®è™Ÿ</th>
                                    <th>ç”³è«‹æ—¥æœŸ</th>
                                    <th>ç”³è«‹éƒ¨é–€</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>ç¸½é‡‘é¡</th>
                                    <th>æ ¸å‡†äºº</th>
                                    <th>æ ¸å‡†æ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="approvedProcurementTable">
                                <!-- å·²æ ¸å‡†çš„è«‹è³¼å–®æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                            </tbody>
                        </table>
                    </div>

                    <div id="approvedPurchaseSection" style="display: none;">
                        <h3>å·²æ ¸å‡†æ¡è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ¡è³¼å–®è™Ÿ</th>
                                    <th>æ¡è³¼æ—¥æœŸ</th>
                                    <th>ä¾›æ‡‰å•†</th>
                                    <th>ç¸½é‡‘é¡</th>
                                    <th>æ ¸å‡†äºº</th>
                                    <th>æ ¸å‡†æ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="approvedPurchaseTable">
                                <!-- å·²æ ¸å‡†çš„æ¡è³¼å–®æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å·²é§å›é é¢ -->
                <div id="rejected" class="page">
                    <h2>ğŸš« å·²é§å›</h2>
                    
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('rejectedDropdown')">
                            é¸æ“‡å–®æ“šé¡å‹ â–¼
                        </button>
                        <div class="dropdown-content" id="rejectedDropdown">
                            <a href="#" onclick="showRejectedType('procurement')">1. è«‹è³¼å–®</a>
                            <a href="#" onclick="showRejectedType('purchase')">2. æ¡è³¼å–®</a>
                        </div>
                    </div>

                    <div id="rejectedProcurementSection">
                        <h3>å·²é§å›è«‹è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>è«‹è³¼å–®è™Ÿ</th>
                                    <th>ç”³è«‹æ—¥æœŸ</th>
                                    <th>ç”³è«‹éƒ¨é–€</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>é§å›äºº</th>
                                    <th>é§å›æ™‚é–“</th>
                                    <th>é§å›åŸå› </th>
                                </tr>
                            </thead>
                            <tbody id="rejectedProcurementTable">
                                <!-- å·²é§å›çš„è«‹è³¼å–®æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                            </tbody>
                        </table>
                    </div>

                    <div id="rejectedPurchaseSection" style="display: none;">
                        <h3>å·²é§å›æ¡è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ¡è³¼å–®è™Ÿ</th>
                                    <th>æ¡è³¼æ—¥æœŸ</th>
                                    <th>ä¾›æ‡‰å•†</th>
                                    <th>ç¸½é‡‘é¡</th>
                                    <th>é§å›äºº</th>
                                    <th>é§å›æ™‚é–“</th>
                                    <th>é§å›åŸå› </th>
                                </tr>
                            </thead>
                            <tbody id="rejectedPurchaseTable">
                                <!-- å·²é§å›çš„æ¡è³¼å–®æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å»ºç«‹æ¡è³¼å–®é é¢ -->
                <div id="createPurchase" class="page">
                    <h2>ğŸ“ å»ºç«‹æ¡è³¼å–®</h2>
                    <form id="purchaseForm">
                        <div class="form-row">
                            <div class="form-col">
                                <label>æ¡è³¼å–®è™Ÿ</label>
                                <input type="text" id="purchaseNo" readonly>
                            </div>
                            <div class="form-col">
                                <label>æ¡è³¼æ—¥æœŸ</label>
                                <input type="date" id="purchaseDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>ä¾›æ‡‰å•†</label>
                                <select id="supplier">
                                    <option value="">è«‹é¸æ“‡ä¾›æ‡‰å•†</option>
                                    <option value="å°ç£é†«æå…¬å¸">å°ç£é†«æå…¬å¸</option>
                                    <option value="åº·å¥é†«ç™‚å™¨æ">åº·å¥é†«ç™‚å™¨æ</option>
                                    <option value="å„ªè³ªè—¥å“ä¾›æ‡‰å•†">å„ªè³ªè—¥å“ä¾›æ‡‰å•†</option>
                                    <option value="å°ˆæ¥­é†«æè¡Œ">å°ˆæ¥­é†«æè¡Œ</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>è¯çµ¡äºº</label>
                                <input type="text" id="contactPerson">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>å‚™è¨»</label>
                                <textarea id="purchaseNote" placeholder="è«‹å¡«å¯«æ¡è³¼å‚™è¨»..."></textarea>
                            </div>
                        </div>
                        
                        <h3>æ¡è³¼å“é …</h3>
                        <button type="button" class="btn btn-primary" onclick="addPurchaseItem()">â• æ–°å¢å“é …</button>
                        
                        <table class="table items-table" id="purchaseItemsTable">
                            <thead>
                                <tr>
                                    <th>å“é …ç·¨è™Ÿ</th>
                                    <th>å“é …åç¨±</th>
                                    <th>è¦æ ¼</th>
                                    <th>æ•¸é‡</th>
                                    <th>å–®ä½</th>
                                    <th>å–®åƒ¹</th>
                                    <th>å°è¨ˆ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseItemsTableBody">
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; text-align: right;">
                            <strong>ç¸½é‡‘é¡ï¼šNT$ <span id="purchaseTotalAmount">0</span></strong>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button type="button" class="btn btn-success" onclick="submitPurchase()">ğŸ“¤ æäº¤æ¡è³¼å–®</button>
                            <button type="button" class="btn btn-secondary" onclick="resetPurchaseForm()">ğŸ”„ é‡è¨­</button>
                        </div>
                    </form>
                </div>

                <!-- åº«å­˜ç®¡ç†é é¢ -->
                <div id="inventory" class="page">
                    <h2>ğŸ“¦ åº«å­˜ç®¡ç†</h2>
                    
                    <!-- åº«å­˜çµ±è¨ˆ -->
                    <div class="inventory-stats">
                        <div class="stat-card">
                            <h3 id="lowStockCount">0</h3>
                            <p>ä½åº«å­˜å“é …</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="outOfStockCount">0</h3>
                            <p>ç¼ºè²¨å“é …</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalItemsCount">0</h3>
                            <p>ç¸½å“é …æ•¸</p>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰éˆ•å€ -->
                    <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <!-- Excelä¸Šå‚³åŠŸèƒ½ -->
                        <div class="file-upload" style="flex: 1; min-width: 300px;" onclick="document.getElementById('excelFile').click()">
                            <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                            <p>ğŸ“ é»æ“Šä¸Šå‚³Excelåº«å­˜æª”æ¡ˆ</p>
                            <p style="font-size: 14px; color: #666;">æ”¯æ´ .xlsx, .xls, .csv æ ¼å¼</p>
                            <p style="font-size: 12px; color: #888;">é æœŸæ¬„ä½ï¼šå“é …ç·¨è™Ÿ,å“é …åç¨±,é¡åˆ¥,è¦æ ¼,ç¾æœ‰åº«å­˜,å®‰å…¨åº«å­˜,å–®ä½</p>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 200px;">
                            <button class="btn btn-success" onclick="addInventoryItem()">â• æ–°å¢åº«å­˜å“é …</button>
                            <button class="btn btn-primary" onclick="downloadInventoryList()">ğŸ’¾ ä¸‹è¼‰åº«å­˜æ¸…å–®</button>
                            <button class="btn btn-secondary" onclick="refreshInventoryStats()">ğŸ”„ æ›´æ–°çµ±è¨ˆ</button>
                        </div>
                    </div>

                    <!-- æœå°‹åŠŸèƒ½ -->
                    <input type="text" class="search-box" placeholder="ğŸ” æœå°‹å“é …åç¨±ã€ç·¨è™Ÿ..." onkeyup="searchInventory(this.value)">

                    <!-- ä¸Šå‚³ç‹€æ…‹é¡¯ç¤º -->
                    <div id="uploadStatus" class="upload-status"></div>

                    <!-- åº«å­˜åˆ—è¡¨ -->
                    <h3 style="color: #ff4757;">âš ï¸ åº«å­˜å“é …ç®¡ç†</h3>
                    <table class="table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>å“é …ç·¨è™Ÿ</th>
                                <th>å“é …åç¨±</th>
                                <th>é¡åˆ¥</th>
                                <th>è¦æ ¼</th>
                                <th>ç¾æœ‰åº«å­˜</th>
                                <th>å®‰å…¨åº«å­˜</th>
                                <th>å–®ä½</th>
                                <th>ç‹€æ…‹</th>
                                <th>æœ€å¾Œæ›´æ–°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- åº«å­˜è³‡æ–™æœƒå‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>

                <!-- ç³»çµ±ç®¡ç†é é¢ -->
                <div id="systemAdmin" class="page">
                    <h2>ğŸ› ï¸ ç³»çµ±ç®¡ç†</h2>
                    
                    <div class="section-divider">
                        <h3>ğŸ‘¤ å¸³å¯†è¨­å®š</h3>
                        <form id="accountForm">
                            <div class="form-row">
                                <div class="form-col">
                                    <label>ä½¿ç”¨è€…å¸³è™Ÿ</label>
                                    <input type="text" id="adminUsername" placeholder="è«‹è¼¸å…¥æ–°å¸³è™Ÿ">
                                </div>
                                <div class="form-col">
                                    <label>ä½¿ç”¨è€…å¯†ç¢¼</label>
                                    <input type="password" id="adminPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <label>ä½¿ç”¨è€…å§“å</label>
                                    <input type="text" id="adminName" placeholder="è«‹è¼¸å…¥ä½¿ç”¨è€…å§“å">
                                </div>
                                <div class="form-col">
                                    <label>éƒ¨é–€</label>
                                    <select id="adminDepartment">
                                        <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
                                        <option value="å…§ç§‘">å…§ç§‘</option>
                                        <option value="å¤–ç§‘">å¤–ç§‘</option>
                                        <option value="æ€¥è¨ºç§‘">æ€¥è¨ºç§‘</option>
                                        <option value="è—¥åŠ‘ç§‘">è—¥åŠ‘ç§‘</option>
                                        <option value="è­·ç†éƒ¨">è­·ç†éƒ¨</option>
                                        <option value="è¡Œæ”¿éƒ¨">è¡Œæ”¿éƒ¨</option>
                                        <option value="æ¡è³¼éƒ¨">æ¡è³¼éƒ¨</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <label>æ¬Šé™ç­‰ç´š</label>
                                    <select id="adminRole">
                                        <option value="">è«‹é¸æ“‡æ¬Šé™</option>
                                        <option value="ç”³è«‹è€…">ç”³è«‹è€…</option>
                                        <option value="å¯©æ ¸è€…">å¯©æ ¸è€…</option>
                                        <option value="ç®¡ç†è€…">ç®¡ç†è€…</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="addUser()">â• æ–°å¢ä½¿ç”¨è€…</button>
                        </form>

                        <h4 style="margin-top: 30px;">ç¾æœ‰ä½¿ç”¨è€…åˆ—è¡¨</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>å¸³è™Ÿ</th>
                                    <th>å§“å</th>
                                    <th>éƒ¨é–€</th>
                                    <th>æ¬Šé™ç­‰ç´š</th>
                                    <th>å»ºç«‹æ—¥æœŸ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userTable">
                                <tr>
                                    <td>admin</td>
                                    <td>ç³»çµ±ç®¡ç†å“¡</td>
                                    <td>è³‡è¨Šéƒ¨</td>
                                    <td><span class="status-badge status-approved">ç®¡ç†è€…</span></td>
                                    <td>2025-01-01</td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editUser('admin')">âœï¸ ç·¨è¼¯</button>
                                        <button class="btn btn-danger" onclick="deleteUser('admin')">ğŸ—‘ï¸ åˆªé™¤</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>doctor01</td>
                                    <td>ç‹é†«å¸«</td>
                                    <td>å…§ç§‘</td>
                                    <td><span class="status-badge status-pending">ç”³è«‹è€…</span></td>
                                    <td>2025-07-01</td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editUser('doctor01')">âœï¸ ç·¨è¼¯</button>
                                        <button class="btn btn-danger" onclick="deleteUser('doctor01')">ğŸ—‘ï¸ åˆªé™¤</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>manager01</td>
                                    <td>é™³ä¸»ç®¡</td>
                                    <td>æ¡è³¼éƒ¨</td>
                                    <td><span class="status-badge status-approved">å¯©æ ¸è€…</span></td>
                                    <td>2025-06-15</td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editUser('manager01')">âœï¸ ç·¨è¼¯</button>
                                        <button class="btn btn-danger" onclick="deleteUser('manager01')">ğŸ—‘ï¸ åˆªé™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="section-divider">
                        <h3>âœ… ç°½æ ¸äººå“¡è¨­å®š</h3>
                        <form id="approverForm">
                            <div class="form-row">
                                <div class="form-col">
                                    <label>ç°½æ ¸æµç¨‹</label>
                                    <select id="approvalProcess">
                                        <option value="">è«‹é¸æ“‡ç°½æ ¸æµç¨‹</option>
                                        <option value="è«‹è³¼å–®å¯©æ ¸">è«‹è³¼å–®å¯©æ ¸</option>
                                        <option value="æ¡è³¼å–®å¯©æ ¸">æ¡è³¼å–®å¯©æ ¸</option>
                                        <option value="ç·Šæ€¥è«‹è³¼å¯©æ ¸">ç·Šæ€¥è«‹è³¼å¯©æ ¸</option>
                                    </select>
                                </div>
                                <div class="form-col">
                                    <label>ç°½æ ¸é †åº</label>
                                    <select id="approvalOrder">
                                        <option value="">è«‹é¸æ“‡é †åº</option>
                                        <option value="1">ç¬¬ä¸€éšç°½æ ¸</option>
                                        <option value="2">ç¬¬äºŒéšç°½æ ¸</option>
                                        <option value="3">ç¬¬ä¸‰éšç°½æ ¸</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <label>ç°½æ ¸äººå“¡</label>
                                    <select id="approverName">
                                        <option value="">è«‹é¸æ“‡ç°½æ ¸äººå“¡</option>
                                        <option value="é™³ä¸»ç®¡">é™³ä¸»ç®¡</option>
                                        <option value="æ—å‰¯é™¢é•·">æ—å‰¯é™¢é•·</option>
                                        <option value="å¼µé™¢é•·">å¼µé™¢é•·</option>
                                    </select>
                                </div>
                                <div class="form-col">
                                    <label>é‡‘é¡é™åˆ¶</label>
                                    <input type="number" id="amountLimit" placeholder="è«‹è¼¸å…¥é‡‘é¡ä¸Šé™">
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="addApprover()">â• æ–°å¢ç°½æ ¸è¨­å®š</button>
                        </form>

                        <h4 style="margin-top: 30px;">ç°½æ ¸æµç¨‹è¨­å®š</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ç°½æ ¸æµç¨‹</th>
                                    <th>ç°½æ ¸é †åº</th>
                                    <th>ç°½æ ¸äººå“¡</th>
                                    <th>é‡‘é¡é™åˆ¶</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="approverTable">
                                <tr>
                                    <td>è«‹è³¼å–®å¯©æ ¸</td>
                                    <td>ç¬¬ä¸€éšç°½æ ¸</td>
                                    <td>é™³ä¸»ç®¡</td>
                                    <td>NT$ 50,000</td>
                                    <td><span class="status-badge status-approved">å•Ÿç”¨</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editApprover(1)">âœï¸ ç·¨è¼¯</button>
                                        <button class="btn btn-danger" onclick="deleteApprover(1)">ğŸ—‘ï¸ åˆªé™¤</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>æ¡è³¼å–®å¯©æ ¸</td>
                                    <td>ç¬¬ä¸€éšç°½æ ¸</td>
                                    <td>æ—å‰¯é™¢é•·</td>
                                    <td>NT$ 100,000</td>
                                    <td><span class="status-badge status-approved">å•Ÿç”¨</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editApprover(2)">âœï¸ ç·¨è¼¯</button>
                                        <button class="btn btn-danger" onclick="deleteApprover(2)">ğŸ—‘ï¸ åˆªé™¤</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>ç·Šæ€¥è«‹è³¼å¯©æ ¸</td>
                                    <td>ç¬¬ä¸€éšç°½æ ¸</td>
                                    <td>å¼µé™¢é•·</td>
                                    <td>ç„¡é™åˆ¶</td>
                                    <td><span class="status-badge status-approved">å•Ÿç”¨</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editApprover(3)">âœï¸ ç·¨è¼¯</button>
                                        <button class="btn btn-danger" onclick="deleteApprover(3)">ğŸ—‘ï¸ åˆªé™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡† -->
    <!-- æŸ¥çœ‹å–®æ“šæ¨¡æ…‹æ¡† -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('viewModal')">&times;</span>
            <h2 id="modalTitle">å–®æ“šè©³æƒ…</h2>
            <div id="modalContent">
                <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>
    </div>

    <!-- åº«å­˜ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="inventoryEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('inventoryEditModal')">&times;</span>
            <h2 id="inventoryModalTitle">ç·¨è¼¯åº«å­˜å“é …</h2>
            <form id="inventoryEditForm">
                <div class="form-row">
                    <div class="form-col">
                        <label>å“é …ç·¨è™Ÿ</label>
                        <input type="text" id="editItemCode" readonly>
                    </div>
                    <div class="form-col">
                        <label>å“é …åç¨±</label>
                        <input type="text" id="editItemName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label>é¡åˆ¥</label>
                        <select id="editCategory" required>
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="è—¥å“">è—¥å“</option>
                            <option value="é†«æ">é†«æ</option>
                            <option value="è€—æ">è€—æ</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>è¦æ ¼</label>
                        <input type="text" id="editSpecification">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label>ç¾æœ‰åº«å­˜</label>
                        <input type="number" id="editCurrentStock" min="0" required>
                    </div>
                    <div class="form-col">
                        <label>å®‰å…¨åº«å­˜</label>
                        <input type="number" id="editSafetyStock" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label>å–®ä½</label>
                        <select id="editUnit" required>
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="ç›’">ç›’</option>
                            <option value="ç“¶">ç“¶</option>
                            <option value="æ”¯">æ”¯</option>
                            <option value="å€‹">å€‹</option>
                            <option value="åŒ…">åŒ…</option>
                            <option value="å°">å°</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-success" onclick="saveInventoryItem()">ğŸ’¾ ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('inventoryEditModal')">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é§å›åŸå› æ¨¡æ…‹æ¡† -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('rejectModal')">&times;</span>
            <h2>é§å›åŸå› </h2>
            <form id="rejectForm">
                <div class="form-group">
                    <label>è«‹å¡«å¯«é§å›åŸå› ï¼š</label>
                    <textarea id="rejectReason" style="width: 100%; height: 100px; margin-top: 10px; padding: 10px;" placeholder="è«‹è©³ç´°èªªæ˜é§å›åŸå› ..."></textarea>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-danger" onclick="confirmReject()">ç¢ºèªé§å›</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('rejectModal')">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentUser = '';
        let itemCounter = 0;
        let purchaseItemCounter = 0;
        let currentRejectDoc = null;
        let currentRejectType = null;
        let pendingProcurements = []; // å„²å­˜å¾…å¯©æ ¸è«‹è³¼å–®
        let pendingPurchases = []; // å„²å­˜å¾…å¯©æ ¸æ¡è³¼å–®
        let approvedProcurements = []; // å„²å­˜å·²æ ¸å‡†è«‹è³¼å–®
        let rejectedProcurements = []; // å„²å­˜å·²é§å›è«‹è³¼å–®
        let inventoryData = []; // å„²å­˜åº«å­˜è³‡æ–™
        let editingInventoryItem = null; // æ­£åœ¨ç·¨è¼¯çš„åº«å­˜é …ç›®

        // é è¨­å¸³å¯†ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²ä½¿ç”¨æ›´å®‰å…¨çš„é©—è­‰æ–¹å¼ï¼‰
        const users = {
            'admin': 'admin123',
            'doctor01': 'doctor123',
            'manager01': 'manager123'
        };

        // ç¢ºä¿DOMè¼‰å…¥å®Œæˆå¾Œå†åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMè¼‰å…¥å®Œæˆ');
            console.log('å¯ç”¨å¸³å¯†:', users);
            
            // ç¢ºä¿ç™»å…¥é é¢é¡¯ç¤º
            const loginPage = document.getElementById('loginPage');
            const mainSystem = document.getElementById('mainSystem');
            
            if (loginPage) {
                loginPage.style.display = 'flex';
                console.log('ç™»å…¥é é¢å·²é¡¯ç¤º');
            }
            
            if (mainSystem) {
                mainSystem.style.display = 'none';
                console.log('ä¸»ç³»çµ±å·²éš±è—');
            }
        });

        // ç™»å…¥åŠŸèƒ½
        function login() {
            console.log('ç™»å…¥å‡½æ•¸è¢«å‘¼å«');
            
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            if (!usernameInput || !passwordInput) {
                console.error('æ‰¾ä¸åˆ°è¼¸å…¥æ¬„ä½');
                alert('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¼¸å…¥æ¬„ä½');
                return;
            }
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            console.log('è¼¸å…¥çš„å¸³è™Ÿ:', username);
            console.log('è¼¸å…¥çš„å¯†ç¢¼:', password);
            console.log('ç³»çµ±ä¸­çš„ä½¿ç”¨è€…:', Object.keys(users));

            if (!username || !password) {
                alert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
                return;
            }

            if (users[username] && users[username] === password) {
                console.log('ç™»å…¥æˆåŠŸ');
                currentUser = username;
                
                const currentUserSpan = document.getElementById('currentUser');
                if (currentUserSpan) {
                    currentUserSpan.textContent = username;
                }
                
                const loginPage = document.getElementById('loginPage');
                const mainSystem = document.getElementById('mainSystem');
                
                if (loginPage) {
                    loginPage.style.display = 'none';
                }
                
                if (mainSystem) {
                    mainSystem.style.display = 'block';
                }
                
                // åˆå§‹åŒ–ç³»çµ±
                initializeSystem();
                showNotification('ç™»å…¥æˆåŠŸï¼', 'success');
            } else {
                console.log('ç™»å…¥å¤±æ•—');
                alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤\n\nå¯ç”¨å¸³å¯†:\nâ€¢ admin / admin123\nâ€¢ doctor01 / doctor123\nâ€¢ manager01 / manager123');
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                currentUser = '';
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('mainSystem').style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }

        // åˆå§‹åŒ–ç³»çµ±
        function initializeSystem() {
            // ç”Ÿæˆè«‹è³¼å–®è™Ÿ
            generateProcurementNo();
            generatePurchaseNo();
            
            // è¨­ç½®ç•¶å‰æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('applyDate').value = today;
            document.getElementById('purchaseDate').value = today;
            
            // åˆå§‹åŒ–åº«å­˜è³‡æ–™
            initializeInventoryData();
            
            // åˆå§‹åŒ–å…¨åŸŸé™£åˆ—
            if (!window.approvedPurchases) {
                window.approvedPurchases = [];
            }
            if (!window.rejectedPurchases) {
                window.rejectedPurchases = [];
            }
            
            // æ¨™è¨˜ç¤ºä¾‹è³‡æ–™
            markExampleData();
        }

        // åˆå§‹åŒ–åº«å­˜è³‡æ–™
        function initializeInventoryData() {
            inventoryData = [
                {
                    itemCode: 'MED001',
                    itemName: 'é˜¿æ–¯åŒ¹éˆ',
                    category: 'è—¥å“',
                    specification: '100mg/éŒ ',
                    currentStock: 5,
                    safetyStock: 50,
                    unit: 'ç›’',
                    lastUpdate: '2025-07-23'
                },
                {
                    itemCode: 'MED002',
                    itemName: 'è¡€å£“è¨ˆ',
                    category: 'é†«æ',
                    specification: 'é›»å­å¼',
                    currentStock: 15,
                    safetyStock: 30,
                    unit: 'å°',
                    lastUpdate: '2025-07-23'
                },
                {
                    itemCode: 'CON001',
                    itemName: 'ä¸€æ¬¡æ€§æ‰‹å¥—',
                    category: 'è€—æ',
                    specification: 'Mè™Ÿ',
                    currentStock: 0,
                    safetyStock: 100,
                    unit: 'ç›’',
                    lastUpdate: '2025-07-22'
                }
            ];
            updateInventoryTable();
            refreshInventoryStats();
        }

        // æ¨™è¨˜ç¤ºä¾‹è³‡æ–™
        function markExampleData() {
            // æ¨™è¨˜å¾…å¯©æ ¸è¡¨æ ¼ä¸­çš„ç¤ºä¾‹è³‡æ–™
            const pendingTable = document.getElementById('pendingProcurementTable');
            if (pendingTable) {
                const rows = pendingTable.querySelectorAll('tr');
                rows.forEach(row => {
                    if (!row.getAttribute('data-dynamic')) {
                        row.setAttribute('data-example', 'true');
                    }
                });
            }
            
            // æ¨™è¨˜å·²æ ¸å‡†è¡¨æ ¼ä¸­çš„ç¤ºä¾‹è³‡æ–™
            const approvedTable = document.getElementById('approvedProcurementTable');
            if (approvedTable) {
                const rows = approvedTable.querySelectorAll('tr');
                rows.forEach(row => {
                    if (!row.getAttribute('data-dynamic')) {
                        row.setAttribute('data-example', 'true');
                    }
                });
            }
            
            // æ¨™è¨˜å·²é§å›è¡¨æ ¼ä¸­çš„ç¤ºä¾‹è³‡æ–™
            const rejectedTable = document.getElementById('rejectedProcurementTable');
            if (rejectedTable) {
                const rows = rejectedTable.querySelectorAll('tr');
                rows.forEach(row => {
                    if (!row.getAttribute('data-dynamic')) {
                        row.setAttribute('data-example', 'true');
                    }
                });
            }
        }

        // é é¢åˆ‡æ›
        function showPage(pageId) {
            // éš±è—æ‰€æœ‰é é¢
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„activeé¡
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // é¡¯ç¤ºæŒ‡å®šé é¢
            document.getElementById(pageId).classList.add('active');
            
            // è¨­ç½®å°æ‡‰æŒ‰éˆ•ç‚ºactive
            event.target.classList.add('active');
        }

        // ç”Ÿæˆè«‹è³¼å–®è™Ÿ
        function generateProcurementNo() {
            const today = new Date();
            const dateStr = today.getFullYear().toString() + 
                           (today.getMonth() + 1).toString().padStart(2, '0') + 
                           today.getDate().toString().padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            document.getElementById('procurementNo').value = `PR${dateStr}${randomNum}`;
        }

        // ç”Ÿæˆæ¡è³¼å–®è™Ÿ
        function generatePurchaseNo() {
            const today = new Date();
            const dateStr = today.getFullYear().toString() + 
                           (today.getMonth() + 1).toString().padStart(2, '0') + 
                           today.getDate().toString().padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            document.getElementById('purchaseNo').value = `PO${dateStr}${randomNum}`;
        }

        // æ–°å¢å“é …
        function addItem() {
            itemCounter++;
            const tableBody = document.getElementById('itemsTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <select name="category_${itemCounter}" onchange="updateTotal()">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="è—¥å“">è—¥å“</option>
                        <option value="é†«æ">é†«æ</option>
                        <option value="è€—æ">è€—æ</option>
                    </select>
                </td>
                <td><input type="text" name="itemName_${itemCounter}" placeholder="å“é …åç¨±"></td>
                <td><input type="text" name="specification_${itemCounter}" placeholder="è¦æ ¼"></td>
                <td><input type="number" name="quantity_${itemCounter}" placeholder="æ•¸é‡" onchange="updateTotal()"></td>
                <td>
                    <select name="unit_${itemCounter}">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ç›’">ç›’</option>
                        <option value="ç“¶">ç“¶</option>
                        <option value="æ”¯">æ”¯</option>
                        <option value="å€‹">å€‹</option>
                        <option value="åŒ…">åŒ…</option>
                        <option value="å°">å°</option>
                    </select>
                </td>
                <td><input type="number" name="unitPrice_${itemCounter}" placeholder="å–®åƒ¹" onchange="updateTotal()"></td>
                <td class="subtotal">0</td>
                <td><button type="button" class="btn btn-danger" onclick="removeItem(this)">ğŸ—‘ï¸</button></td>
            `;
            tableBody.appendChild(row);
        }

        // ç§»é™¤å“é …
        function removeItem(button) {
            button.closest('tr').remove();
            updateTotal();
        }

        // æ›´æ–°ç¸½é‡‘é¡
        function updateTotal() {
            let total = 0;
            const tableBody = document.getElementById('itemsTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('input[name^="quantity"]').value) || 0;
                const unitPrice = parseFloat(row.querySelector('input[name^="unitPrice"]').value) || 0;
                const subtotal = quantity * unitPrice;
                
                row.querySelector('.subtotal').textContent = subtotal.toLocaleString();
                total += subtotal;
            });
            
            document.getElementById('totalAmount').textContent = total.toLocaleString();
        }

        // æäº¤è«‹è³¼å–®
        function submitProcurement() {
            const form = document.getElementById('procurementForm');
            
            // åŸºæœ¬è³‡æ–™é©—è­‰
            const procurementNo = document.getElementById('procurementNo').value;
            const applyDate = document.getElementById('applyDate').value;
            const department = document.getElementById('department').value;
            const applicantName = document.getElementById('applicantName').value;
            const procurementReason = document.getElementById('procurementReason').value;
            
            if (!department) {
                alert('è«‹é¸æ“‡ç”³è«‹éƒ¨é–€');
                return;
            }
            
            if (!applicantName) {
                alert('è«‹å¡«å¯«ç”³è«‹äººå§“å');
                return;
            }
            
            if (!procurementReason) {
                alert('è«‹å¡«å¯«è«‹è³¼äº‹ç”±');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å“é …
            const tableBody = document.getElementById('itemsTableBody');
            if (tableBody.children.length === 0) {
                alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹å“é …');
                return;
            }
            
            // é©—è­‰å“é …è³‡æ–™ä¸¦æ”¶é›†å“é …è³‡è¨Š
            let isValid = true;
            let items = [];
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach((row, index) => {
                const category = row.querySelector('select[name^="category"]').value;
                const itemName = row.querySelector('input[name^="itemName"]').value;
                const specification = row.querySelector('input[name^="specification"]').value;
                const quantity = row.querySelector('input[name^="quantity"]').value;
                const unit = row.querySelector('select[name^="unit"]').value;
                const unitPrice = row.querySelector('input[name^="unitPrice"]').value;
                
                if (!category || !itemName || !quantity || !unit) {
                    alert(`ç¬¬ ${index + 1} å€‹å“é …è³‡æ–™ä¸å®Œæ•´`);
                    isValid = false;
                    return;
                }
                
                items.push({
                    category,
                    itemName,
                    specification,
                    quantity: parseInt(quantity),
                    unit,
                    unitPrice: parseFloat(unitPrice) || 0,
                    subtotal: (parseInt(quantity) * (parseFloat(unitPrice) || 0))
                });
            });
            
            if (!isValid) return;
            
            // è¨ˆç®—ç¸½é‡‘é¡
            const totalAmount = items.reduce((sum, item) => sum + item.subtotal, 0);
            
            // å‰µå»ºæ–°çš„è«‹è³¼å–®ç‰©ä»¶
            const newProcurement = {
                procurementNo,
                applyDate,
                department,
                applicantName,
                procurementReason,
                items,
                totalAmount,
                status: 'å¾…å¯©æ ¸',
                submitTime: new Date().toLocaleString('zh-TW')
            };
            
            // åŠ å…¥åˆ°å¾…å¯©æ ¸åˆ—è¡¨
            pendingProcurements.push(newProcurement);
            
            // æ›´æ–°ç°½æ ¸ç®¡ç†é é¢çš„è¡¨æ ¼
            updatePendingProcurementTable();
            
            // æäº¤æˆåŠŸ
            showNotification('è«‹è³¼å–®æäº¤æˆåŠŸï¼', 'success');
            resetForm();
            
            // æ›´æ–°å¾…å¯©æ ¸æ•¸é‡
            updatePendingCount();
            
            console.log('æ–°è«‹è³¼å–®å·²åŠ å…¥:', newProcurement);
        }

        // é‡è¨­è¡¨å–®
        function resetForm() {
            document.getElementById('procurementForm').reset();
            document.getElementById('itemsTableBody').innerHTML = '';
            document.getElementById('totalAmount').textContent = '0';
            generateProcurementNo();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('applyDate').value = today;
            itemCounter = 0;
        }

        // è™•ç†Excelä¸Šå‚³
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name;
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            
            showUploadStatus(`æ­£åœ¨ä¸Šå‚³ ${fileName} (${fileSize}MB)...`, 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        parseCSVData(data);
                    } else if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                        parseExcelData(data);
                    } else {
                        throw new Error('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼');
                    }
                } catch (error) {
                    console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                    showUploadStatus('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼š' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showUploadStatus('æª”æ¡ˆè®€å–å¤±æ•—', 'error');
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // è§£æCSVè³‡æ–™
        function parseCSVData(csvData) {
            try {
                const lines = csvData.split('\n');
                if (lines.length < 2) {
                    throw new Error('æª”æ¡ˆå…§å®¹ä¸è¶³');
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                console.log('CSV æ¨™é¡Œ:', headers);
                
                // æª¢æŸ¥å¿…è¦æ¬„ä½
                const requiredFields = ['å“é …ç·¨è™Ÿ', 'å“é …åç¨±', 'é¡åˆ¥', 'ç¾æœ‰åº«å­˜', 'å®‰å…¨åº«å­˜', 'å–®ä½'];
                const missingFields = requiredFields.filter(field => !headers.includes(field));
                
                if (missingFields.length > 0) {
                    throw new Error(`ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š${missingFields.join(', ')}`);
                }
                
                const newInventoryData = [];
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    try {
                        const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                        
                        if (values.length < headers.length) {
                            console.warn(`ç¬¬ ${i + 1} è¡Œè³‡æ–™ä¸å®Œæ•´:`, values);
                            errorCount++;
                            continue;
                        }

                        const rowData = {};
                        headers.forEach((header, index) => {
                            rowData[header] = values[index] || '';
                        });

                        // é©—è­‰å¿…è¦æ¬„ä½
                        if (!rowData['å“é …ç·¨è™Ÿ'] || !rowData['å“é …åç¨±'] || !rowData['é¡åˆ¥']) {
                            console.warn(`ç¬¬ ${i + 1} è¡Œç¼ºå°‘å¿…è¦è³‡æ–™:`, rowData);
                            errorCount++;
                            continue;
                        }

                        const currentStock = parseInt(rowData['ç¾æœ‰åº«å­˜']) || 0;
                        const safetyStock = parseInt(rowData['å®‰å…¨åº«å­˜']) || 0;

                        newInventoryData.push({
                            itemCode: rowData['å“é …ç·¨è™Ÿ'],
                            itemName: rowData['å“é …åç¨±'],
                            category: rowData['é¡åˆ¥'],
                            specification: rowData['è¦æ ¼'] || '',
                            currentStock: currentStock,
                            safetyStock: safetyStock,
                            unit: rowData['å–®ä½'] || 'å€‹',
                            lastUpdate: new Date().toISOString().split('T')[0]
                        });
                        
                        successCount++;
                    } catch (rowError) {
                        console.error(`ç¬¬ ${i + 1} è¡Œè§£æéŒ¯èª¤:`, rowError);
                        errorCount++;
                    }
                }
                
                if (newInventoryData.length > 0) {
                    inventoryData = newInventoryData;
                    updateInventoryTable();
                    refreshInventoryStats();
                    showUploadStatus(`CSVåŒ¯å…¥æˆåŠŸï¼å…± ${successCount} ç­†è³‡æ–™${errorCount > 0 ? `ï¼Œ${errorCount} ç­†éŒ¯èª¤` : ''}`, 'success');
                } else {
                    throw new Error('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åº«å­˜è³‡æ–™');
                }
            } catch (error) {
                console.error('CSVè§£æéŒ¯èª¤:', error);
                showUploadStatus('CSVè§£æå¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // è§£æExcelè³‡æ–™
        function parseExcelData(data) {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Excelè§£æåº«æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }

                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    throw new Error('Excelæª”æ¡ˆå…§å®¹ä¸è¶³');
                }
                
                const headers = jsonData[0].map(h => (h || '').toString().trim());
                console.log('Excel æ¨™é¡Œ:', headers);
                
                // æª¢æŸ¥å¿…è¦æ¬„ä½
                const requiredFields = ['å“é …ç·¨è™Ÿ', 'å“é …åç¨±', 'é¡åˆ¥', 'ç¾æœ‰åº«å­˜', 'å®‰å…¨åº«å­˜', 'å–®ä½'];
                const missingFields = requiredFields.filter(field => !headers.includes(field));
                
                if (missingFields.length > 0) {
                    throw new Error(`ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š${missingFields.join(', ')}`);
                }
                
                const newInventoryData = [];
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;
                    
                    try {
                        const rowData = {};
                        headers.forEach((header, index) => {
                            rowData[header] = (row[index] || '').toString().trim();
                        });
                        
                        // é©—è­‰å¿…è¦æ¬„ä½
                        if (!rowData['å“é …ç·¨è™Ÿ'] || !rowData['å“é …åç¨±'] || !rowData['é¡åˆ¥']) {
                            console.warn(`ç¬¬ ${i + 1} è¡Œç¼ºå°‘å¿…è¦è³‡æ–™:`, rowData);
                            errorCount++;
                            continue;
                        }
                        
                        const currentStock = parseInt(rowData['ç¾æœ‰åº«å­˜']) || 0;
                        const safetyStock = parseInt(rowData['å®‰å…¨åº«å­˜']) || 0;
                        
                        newInventoryData.push({
                            itemCode: rowData['å“é …ç·¨è™Ÿ'],
                            itemName: rowData['å“é …åç¨±'],
                            category: rowData['é¡åˆ¥'],
                            specification: rowData['è¦æ ¼'] || '',
                            currentStock: currentStock,
                            safetyStock: safetyStock,
                            unit: rowData['å–®ä½'] || 'å€‹',
                            lastUpdate: new Date().toISOString().split('T')[0]
                        });
                        
                        successCount++;
                    } catch (rowError) {
                        console.error(`ç¬¬ ${i + 1} è¡Œè§£æéŒ¯èª¤:`, rowError);
                        errorCount++;
                    }
                }
                
                if (newInventoryData.length > 0) {
                    inventoryData = newInventoryData;
                    updateInventoryTable();
                    refreshInventoryStats();
                    showUploadStatus(`ExcelåŒ¯å…¥æˆåŠŸï¼å…± ${successCount} ç­†è³‡æ–™${errorCount > 0 ? `ï¼Œ${errorCount} ç­†éŒ¯èª¤` : ''}`, 'success');
                } else {
                    throw new Error('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åº«å­˜è³‡æ–™');
                }
            } catch (error) {
                console.error('Excelè§£æéŒ¯èª¤:', error);
                showUploadStatus('Excelè§£æå¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // é¡¯ç¤ºä¸Šå‚³ç‹€æ…‹
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            const className = type === 'success' ? 'status-success' : 
                             type === 'error' ? 'status-error' : 'status-info';
            
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            // 3ç§’å¾Œæ¸…é™¤ç‹€æ…‹è¨Šæ¯
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }

        // æ›´æ–°åº«å­˜è¡¨æ ¼
        function updateInventoryTable() {
            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = '';
            
            inventoryData.forEach(item => {
                const row = document.createElement('tr');
                const status = getInventoryStatus(item);
                const statusClass = status === 'ç¼ºè²¨' ? 'status-rejected' : status === 'ä½åº«å­˜' ? 'status-pending' : 'status-approved';
                const stockColor = item.currentStock === 0 ? '#ff4757' : item.currentStock < item.safetyStock ? '#ffa726' : '#2ed573';
                
                row.innerHTML = `
                    <td>${item.itemCode}</td>
                    <td>${item.itemName}</td>
                    <td>${item.category}</td>
                    <td>${item.specification}</td>
                    <td style="color: ${stockColor}; font-weight: bold;">${item.currentStock}</td>
                    <td>${item.safetyStock}</td>
                    <td>${item.unit}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>${item.lastUpdate}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editInventoryItem('${item.itemCode}')">âœï¸ ç·¨è¼¯</button>
                        <button class="btn btn-danger" onclick="deleteInventoryItem('${item.itemCode}')">ğŸ—‘ï¸ åˆªé™¤</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // ç²å–åº«å­˜ç‹€æ…‹
        function getInventoryStatus(item) {
            if (item.currentStock === 0) return 'ç¼ºè²¨';
            if (item.currentStock < item.safetyStock) return 'ä½åº«å­˜';
            return 'æ­£å¸¸';
        }

        // åˆ·æ–°åº«å­˜çµ±è¨ˆ
        function refreshInventoryStats() {
            const lowStockCount = inventoryData.filter(item => item.currentStock > 0 && item.currentStock < item.safetyStock).length;
            const outOfStockCount = inventoryData.filter(item => item.currentStock === 0).length;
            const totalCount = inventoryData.length;
            
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('outOfStockCount').textContent = outOfStockCount;
            document.getElementById('totalItemsCount').textContent = totalCount;
        }

        // ä¸‹æ‹‰é¸å–®åŠŸèƒ½
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('show');
        }

        // é¡¯ç¤ºç°½æ ¸é¡å‹
        function showApprovalType(type) {
            if (type === 'procurement') {
                document.getElementById('procurementApproval').style.display = 'block';
                document.getElementById('purchaseApproval').style.display = 'none';
            } else {
                document.getElementById('procurementApproval').style.display = 'none';
                document.getElementById('purchaseApproval').style.display = 'block';
            }
            toggleDropdown('approvalDropdown');
        }

        // é¡¯ç¤ºå·²æ ¸å‡†é¡å‹
        function showApprovedType(type) {
            if (type === 'procurement') {
                document.getElementById('approvedProcurementSection').style.display = 'block';
                document.getElementById('approvedPurchaseSection').style.display = 'none';
            } else {
                document.getElementById('approvedProcurementSection').style.display = 'none';
                document.getElementById('approvedPurchaseSection').style.display = 'block';
            }
            toggleDropdown('approvedDropdown');
        }

        // é¡¯ç¤ºå·²é§å›é¡å‹
        function showRejectedType(type) {
            if (type === 'procurement') {
                document.getElementById('rejectedProcurementSection').style.display = 'block';
                document.getElementById('rejectedPurchaseSection').style.display = 'none';
            } else {
                document.getElementById('rejectedProcurementSection').style.display = 'none';
                document.getElementById('rejectedPurchaseSection').style.display = 'block';
            }
            toggleDropdown('rejectedDropdown');
        }

        // æ ¸å‡†æ–‡ä»¶
        function approveDocument(docId, type) {
            if (confirm(`ç¢ºå®šè¦æ ¸å‡† ${docId} å—ï¼Ÿ`)) {
                if (type === 'procurement') {
                    // å¾å¾…å¯©æ ¸ä¸­ç§»é™¤
                    const index = pendingProcurements.findIndex(proc => proc.procurementNo === docId);
                    if (index > -1) {
                        const approvedProc = pendingProcurements.splice(index, 1)[0];
                        approvedProc.status = 'å·²æ ¸å‡†';
                        approvedProc.approver = currentUser;
                        approvedProc.approveTime = new Date().toLocaleString('zh-TW');
                        approvedProcurements.push(approvedProc);
                        
                        // æ›´æ–°è¡¨æ ¼
                        updatePendingProcurementTable();
                        updateApprovedProcurementTable();
                    }
                } else if (type === 'purchase') {
                    // å¾å¾…å¯©æ ¸æ¡è³¼å–®ä¸­ç§»é™¤
                    const index = pendingPurchases.findIndex(purch => purch.purchaseNo === docId);
                    if (index > -1) {
                        const approvedPurch = pendingPurchases.splice(index, 1)[0];
                        approvedPurch.status = 'å·²æ ¸å‡†';
                        approvedPurch.approver = currentUser;
                        approvedPurch.approveTime = new Date().toLocaleString('zh-TW');
                        
                        // ç¢ºä¿å·²æ ¸å‡†æ¡è³¼å–®é™£åˆ—å­˜åœ¨
                        if (!window.approvedPurchases) {
                            window.approvedPurchases = [];
                        }
                        window.approvedPurchases.push(approvedPurch);
                        
                        // æ›´æ–°è¡¨æ ¼
                        updatePendingPurchaseTable();
                        updateApprovedPurchaseTable();
                    }
                }
                
                showNotification(`${docId} å·²æ ¸å‡†`, 'success');
                updatePendingCount();
            }
        }

        // é§å›æ–‡ä»¶
        function rejectDocument(docId, type) {
            currentRejectDoc = docId;
            currentRejectType = type;
            document.getElementById('rejectModal').style.display = 'block';
        }

        // é§å›æ–‡ä»¶
        function rejectDocument(docId, type) {
            currentRejectDoc = docId;
            currentRejectType = type;
            document.getElementById('rejectModal').style.display = 'block';
        }

        // ç¢ºèªé§å›
        function confirmReject() {
            const reason = document.getElementById('rejectReason').value;
            if (!reason.trim()) {
                alert('è«‹å¡«å¯«é§å›åŸå› ');
                return;
            }
            
            if (currentRejectType === 'procurement') {
                // å¾å¾…å¯©æ ¸ä¸­ç§»é™¤
                const index = pendingProcurements.findIndex(proc => proc.procurementNo === currentRejectDoc);
                if (index > -1) {
                    const rejectedProc = pendingProcurements.splice(index, 1)[0];
                    rejectedProc.status = 'å·²é§å›';
                    rejectedProc.rejecter = currentUser;
                    rejectedProc.rejectTime = new Date().toLocaleString('zh-TW');
                    rejectedProc.rejectReason = reason;
                    rejectedProcurements.push(rejectedProc);
                    
                    // æ›´æ–°è¡¨æ ¼
                    updatePendingProcurementTable();
                    updateRejectedProcurementTable();
                }
            } else if (currentRejectType === 'purchase') {
                // å¾å¾…å¯©æ ¸æ¡è³¼å–®ä¸­ç§»é™¤
                const index = pendingPurchases.findIndex(purch => purch.purchaseNo === currentRejectDoc);
                if (index > -1) {
                    const rejectedPurch = pendingPurchases.splice(index, 1)[0];
                    rejectedPurch.status = 'å·²é§å›';
                    rejectedPurch.rejecter = currentUser;
                    rejectedPurch.rejectTime = new Date().toLocaleString('zh-TW');
                    rejectedPurch.rejectReason = reason;
                    
                    // ç¢ºä¿å·²é§å›æ¡è³¼å–®é™£åˆ—å­˜åœ¨
                    if (!window.rejectedPurchases) {
                        window.rejectedPurchases = [];
                    }
                    window.rejectedPurchases.push(rejectedPurch);
                    
                    // æ›´æ–°è¡¨æ ¼
                    updatePendingPurchaseTable();
                    updateRejectedPurchaseTable();
                }
            }
            
            showNotification(`${currentRejectDoc} å·²é§å›`, 'success');
            closeModal('rejectModal');
            document.getElementById('rejectReason').value = '';
            updatePendingCount();
        }

        // æŸ¥çœ‹æ–‡ä»¶ - ä¿®æ”¹ç‚ºæ”¯æŒå‹•æ…‹è³‡æ–™
        function viewDocument(docId) {
            let documentData = null;
            
            // å¾å¾…å¯©æ ¸è«‹è³¼å–®ä¸­å°‹æ‰¾
            documentData = pendingProcurements.find(proc => proc.procurementNo === docId);
            
            // å¦‚æœåœ¨å¾…å¯©æ ¸ä¸­æ²’æ‰¾åˆ°ï¼Œå†å¾å·²æ ¸å‡†ä¸­å°‹æ‰¾
            if (!documentData) {
                documentData = approvedProcurements.find(proc => proc.procurementNo === docId);
            }
            
            // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œå¾å·²é§å›ä¸­å°‹æ‰¾
            if (!documentData) {
                documentData = rejectedProcurements.find(proc => proc.procurementNo === docId);
            }
            
            if (documentData) {
                // é¡¯ç¤ºçœŸå¯¦çš„è«‹è³¼å–®è³‡æ–™
                document.getElementById('modalTitle').textContent = `æŸ¥çœ‹ ${docId}`;
                
                let itemsTableHTML = '';
                documentData.items.forEach(item => {
                    itemsTableHTML += `
                        <tr>
                            <td>${item.category}</td>
                            <td>${item.itemName}</td>
                            <td>${item.specification || '-'}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>${item.unitPrice.toLocaleString()}</td>
                            <td>${item.subtotal.toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                document.getElementById('modalContent').innerHTML = `
                    <div class="form-row">
                        <div class="form-col">
                            <strong>è«‹è³¼å–®è™Ÿï¼š</strong>${documentData.procurementNo}
                        </div>
                        <div class="form-col">
                            <strong>ç”³è«‹æ—¥æœŸï¼š</strong>${documentData.applyDate}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <strong>ç”³è«‹éƒ¨é–€ï¼š</strong>${documentData.department}
                        </div>
                        <div class="form-col">
                            <strong>ç”³è«‹äººï¼š</strong>${documentData.applicantName}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <strong>è«‹è³¼äº‹ç”±ï¼š</strong>${documentData.procurementReason}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <strong>æäº¤æ™‚é–“ï¼š</strong>${documentData.submitTime}
                        </div>
                        <div class="form-col">
                            <strong>ç‹€æ…‹ï¼š</strong><span class="status-badge ${documentData.status === 'å·²æ ¸å‡†' ? 'status-approved' : documentData.status === 'å·²é§å›' ? 'status-rejected' : 'status-pending'}">${documentData.status}</span>
                        </div>
                    </div>
                    ${documentData.approver ? `
                    <div class="form-row">
                        <div class="form-col">
                            <strong>æ ¸å‡†äººï¼š</strong>${documentData.approver}
                        </div>
                        <div class="form-col">
                            <strong>æ ¸å‡†æ™‚é–“ï¼š</strong>${documentData.approveTime}
                        </div>
                    </div>` : ''}
                    ${documentData.rejecter ? `
                    <div class="form-row">
                        <div class="form-col">
                            <strong>é§å›äººï¼š</strong>${documentData.rejecter}
                        </div>
                        <div class="form-col">
                            <strong>é§å›æ™‚é–“ï¼š</strong>${documentData.rejectTime}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <strong>é§å›åŸå› ï¼š</strong>${documentData.rejectReason}
                        </div>
                    </div>` : ''}
                    <h4>è«‹è³¼å“é …</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>é¡åˆ¥</th>
                                <th>åç¨±</th>
                                <th>è¦æ ¼</th>
                                <th>æ•¸é‡</th>
                                <th>å–®ä½</th>
                                <th>é ä¼°å–®åƒ¹</th>
                                <th>å°è¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsTableHTML}
                        </tbody>
                    </table>
                    <div style="text-align: right; margin-top: 10px;">
                        <strong>ç¸½é‡‘é¡ï¼šNT$ ${documentData.totalAmount.toLocaleString()}</strong>
                    </div>
                `;
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°è³‡æ–™ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                document.getElementById('modalTitle').textContent = `æŸ¥çœ‹ ${docId}`;
                document.getElementById('modalContent').innerHTML = `
                    <div class="alert alert-danger">
                        æ‰¾ä¸åˆ°æ­¤å–®æ“šçš„è©³ç´°è³‡æ–™
                    </div>
                `;
            }
            
            document.getElementById('viewModal').style.display = 'block';
        }

        // æ›´æ–°å¾…å¯©æ ¸è«‹è³¼å–®è¡¨æ ¼
        function updatePendingProcurementTable() {
            const tableBody = document.getElementById('pendingProcurementTable');
            
            // æ¸…ç©ºæ‰€æœ‰å‹•æ…‹æ–°å¢çš„è¡Œ
            const dynamicRows = tableBody.querySelectorAll('tr[data-dynamic="true"]');
            dynamicRows.forEach(row => row.remove());
            
            // é‡æ–°æ·»åŠ å¾…å¯©æ ¸çš„è«‹è³¼å–®
            pendingProcurements.forEach(procurement => {
                const row = document.createElement('tr');
                row.setAttribute('data-dynamic', 'true');
                row.innerHTML = `
                    <td>${procurement.procurementNo}</td>
                    <td>${procurement.applyDate}</td>
                    <td>${procurement.department}</td>
                    <td>${procurement.applicantName}</td>
                    <td><span class="status-badge status-pending">å¾…å¯©æ ¸</span></td>
                    <td>
                        <button class="btn btn-success" onclick="approveDocument('${procurement.procurementNo}', 'procurement')">âœ… æ ¸å‡†</button>
                        <button class="btn btn-danger" onclick="rejectDocument('${procurement.procurementNo}', 'procurement')">ğŸš« é§å›</button>
                        <button class="btn btn-primary" onclick="viewDocument('${procurement.procurementNo}')">ğŸ‘ï¸ æŸ¥çœ‹</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // æ›´æ–°å¾…å¯©æ ¸æ¡è³¼å–®è¡¨æ ¼
        function updatePendingPurchaseTable() {
            const tableBody = document.getElementById('pendingPurchaseTable');
            
            // æ¸…ç©ºæ‰€æœ‰å‹•æ…‹æ–°å¢çš„è¡Œ
            const dynamicRows = tableBody.querySelectorAll('tr[data-dynamic="true"]');
            dynamicRows.forEach(row => row.remove());
            
            // é‡æ–°æ·»åŠ å¾…å¯©æ ¸çš„æ¡è³¼å–®
            pendingPurchases.forEach(purchase => {
                const row = document.createElement('tr');
                row.setAttribute('data-dynamic', 'true');
                row.innerHTML = `
                    <td>${purchase.purchaseNo}</td>
                    <td>${purchase.purchaseDate}</td>
                    <td>${purchase.supplier}</td>
                    <td style="text-align: right; font-weight: bold;">NT$ ${purchase.totalAmount.toLocaleString()}</td>
                    <td><span class="status-badge status-pending">å¾…å¯©æ ¸</span></td>
                    <td>
                        <button class="btn btn-success" onclick="approveDocument('${purchase.purchaseNo}', 'purchase')">âœ… æ ¸å‡†</button>
                        <button class="btn btn-danger" onclick="rejectDocument('${purchase.purchaseNo}', 'purchase')">ğŸš« é§å›</button>
                        <button class="btn btn-primary" onclick="viewPurchaseDocument('${purchase.purchaseNo}')">ğŸ‘ï¸ æŸ¥çœ‹</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // æ›´æ–°å·²æ ¸å‡†æ¡è³¼å–®è¡¨æ ¼
        function updateApprovedPurchaseTable() {
            const tableBody = document.getElementById('approvedPurchaseTable');
            
            // æ¸…ç©ºç¾æœ‰çš„å‹•æ…‹è³‡æ–™
            const dynamicRows = tableBody.querySelectorAll('tr[data-dynamic="true"]');
            dynamicRows.forEach(row => row.remove());
            
            // ç¢ºä¿å·²æ ¸å‡†æ¡è³¼å–®é™£åˆ—å­˜åœ¨
            if (!window.approvedPurchases) {
                window.approvedPurchases = [];
            }
            
            // æ·»åŠ å·²æ ¸å‡†çš„æ¡è³¼å–®
            window.approvedPurchases.forEach(purchase => {
                const row = document.createElement('tr');
                row.setAttribute('data-dynamic', 'true');
                row.innerHTML = `
                    <td>${purchase.purchaseNo}</td>
                    <td>${purchase.purchaseDate}</td>
                    <td>${purchase.supplier}</td>
                    <td style="text-align: right; font-weight: bold;">NT$ ${purchase.totalAmount.toLocaleString()}</td>
                    <td>${purchase.approver}</td>
                    <td>${purchase.approveTime}</td>
                    <td>
                        <button class="btn btn-primary" onclick="downloadPurchaseDocument('${purchase.purchaseNo}')">ğŸ’¾ ä¸‹è¼‰</button>
                        <button class="btn btn-secondary" onclick="viewPurchaseDocument('${purchase.purchaseNo}')">ğŸ‘ï¸ æŸ¥çœ‹</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // æŸ¥çœ‹æ¡è³¼æ–‡ä»¶
        function viewPurchaseDocument(docId) {
            let documentData = null;
            
            // å¾å¾…å¯©æ ¸æ¡è³¼å–®ä¸­å°‹æ‰¾
            documentData = pendingPurchases.find(purch => purch.purchaseNo === docId);
            
            // å¦‚æœåœ¨å¾…å¯©æ ¸ä¸­æ²’æ‰¾åˆ°ï¼Œå†å¾å·²æ ¸å‡†ä¸­å°‹æ‰¾
            if (!documentData && window.approvedPurchases) {
                documentData = window.approvedPurchases.find(purch => purch.purchaseNo === docId);
            }
            
            // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œå¾å·²é§å›ä¸­å°‹æ‰¾
            if (!documentData && window.rejectedPurchases) {
                documentData = window.rejectedPurchases.find(purch => purch.purchaseNo === docId);
            }
            
            if (documentData) {
                // é¡¯ç¤ºçœŸå¯¦çš„æ¡è³¼å–®è³‡æ–™
                document.getElementById('modalTitle').textContent = `æŸ¥çœ‹ ${docId}`;
                
                let itemsTableHTML = '';
                documentData.items.forEach(item => {
                    itemsTableHTML += `
                        <tr>
                            <td>${item.itemCode}</td>
                            <td>${item.itemName}</td>
                            <td>${item.specification || '-'}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>${item.unitPrice.toLocaleString()}</td>
                            <td>${item.subtotal.toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                document.getElementById('modalContent').innerHTML = `
                    <div class="form-row">
                        <div class="form-col">
                            <strong>æ¡è³¼å–®è™Ÿï¼š</strong>${documentData.purchaseNo}
                        </div>
                        <div class="form-col">
                            <strong>æ¡è³¼æ—¥æœŸï¼š</strong>${documentData.purchaseDate}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <strong>ä¾›æ‡‰å•†ï¼š</strong>${documentData.supplier}
                        </div>
                        <div class="form-col">
                            <strong>è¯çµ¡äººï¼š</strong>${documentData.contactPerson}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <strong>å‚™è¨»ï¼š</strong>${documentData.purchaseNote || 'ç„¡'}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <strong>æäº¤æ™‚é–“ï¼š</strong>${documentData.submitTime}
                        </div>
                        <div class="form-col">
                            <strong>ç‹€æ…‹ï¼š</strong><span class="status-badge ${documentData.status === 'å·²æ ¸å‡†' ? 'status-approved' : documentData.status === 'å·²é§å›' ? 'status-rejected' : 'status-pending'}">${documentData.status}</span>
                        </div>
                    </div>
                    ${documentData.approver ? `
                    <div class="form-row">
                        <div class="form-col">
                            <strong>æ ¸å‡†äººï¼š</strong>${documentData.approver}
                        </div>
                        <div class="form-col">
                            <strong>æ ¸å‡†æ™‚é–“ï¼š</strong>${documentData.approveTime}
                        </div>
                    </div>` : ''}
                    ${documentData.rejecter ? `
                    <div class="form-row">
                        <div class="form-col">
                            <strong>é§å›äººï¼š</strong>${documentData.rejecter}
                        </div>
                        <div class="form-col">
                            <strong>é§å›æ™‚é–“ï¼š</strong>${documentData.rejectTime}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <strong>é§å›åŸå› ï¼š</strong>${documentData.rejectReason}
                        </div>
                    </div>` : ''}
                    <h4>æ¡è³¼å“é …</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>å“é …ç·¨è™Ÿ</th>
                                <th>å“é …åç¨±</th>
                                <th>è¦æ ¼</th>
                                <th>æ•¸é‡</th>
                                <th>å–®ä½</th>
                                <th>å–®åƒ¹</th>
                                <th>å°è¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsTableHTML}
                        </tbody>
                    </table>
                    <div style="text-align: right; margin-top: 10px;">
                        <strong>ç¸½é‡‘é¡ï¼šNT$ ${documentData.totalAmount.toLocaleString()}</strong>
                    </div>
                `;
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°è³‡æ–™ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                document.getElementById('modalTitle').textContent = `æŸ¥çœ‹ ${docId}`;
                document.getElementById('modalContent').innerHTML = `
                    <div class="alert alert-danger">
                        æ‰¾ä¸åˆ°æ­¤æ¡è³¼å–®çš„è©³ç´°è³‡æ–™
                    </div>
                `;
            }
            
            document.getElementById('viewModal').style.display = 'block';
        }

        // ä¸‹è¼‰æ¡è³¼æ–‡ä»¶
        function downloadPurchaseDocument(docId) {
            showNotification(`æ­£åœ¨ç”Ÿæˆ ${docId} PDFæª”æ¡ˆ...`, 'success');
            
            // å°‹æ‰¾æ¡è³¼å–®è³‡æ–™
            let documentData = null;
            
            if (window.approvedPurchases) {
                documentData = window.approvedPurchases.find(purch => purch.purchaseNo === docId);
            }
            
            if (!documentData && pendingPurchases) {
                documentData = pendingPurchases.find(purch => purch.purchaseNo === docId);
            }
            
            if (!documentData && window.rejectedPurchases) {
                documentData = window.rejectedPurchases.find(purch => purch.purchaseNo === docId);
            }
            
            if (documentData) {
                // ç”ŸæˆçœŸå¯¦çš„PDFå…§å®¹
                generatePDF(documentData, 'purchase');
            } else {
                // ç”Ÿæˆç¤ºä¾‹PDF
                generateSamplePurchasePDF(docId);
            }
        }

        // ç”Ÿæˆç¤ºä¾‹æ¡è³¼å–®PDF
        function generateSamplePurchasePDF(docId) {
            const sampleData = {
                purchaseNo: docId,
                purchaseDate: '2025-07-24',
                supplier: 'ç¤ºä¾‹ä¾›æ‡‰å•†',
                contactPerson: 'ç¤ºä¾‹è¯çµ¡äºº',
                purchaseNote: 'ç¤ºä¾‹æ¡è³¼å‚™è¨»',
                status: 'å·²æ ¸å‡†',
                submitTime: new Date().toLocaleString('zh-TW'),
                items: [
                    {
                        itemCode: 'PUR001',
                        itemName: 'è¡€å£“è¨ˆ',
                        specification: 'é›»å­å¼',
                        quantity: 2,
                        unit: 'å°',
                        unitPrice: 1500,
                        subtotal: 3000
                    },
                    {
                        itemCode: 'PUR002',
                        itemName: 'é«”æº«è¨ˆ',
                        specification: 'ç´…å¤–ç·š',
                        quantity: 5,
                        unit: 'æ”¯',
                        unitPrice: 200,
                        subtotal: 1000
                    }
                ],
                totalAmount: 4000
            };
            generatePDF(sampleData, 'purchase');
        }

        // æ›´æ–°å·²æ ¸å‡†è«‹è³¼å–®è¡¨æ ¼
        function updateApprovedProcurementTable() {
            const tableBody = document.getElementById('approvedProcurementTable');
            
            // æ¸…ç©ºç¾æœ‰çš„å‹•æ…‹è³‡æ–™
            const dynamicRows = tableBody.querySelectorAll('tr[data-dynamic="true"]');
            dynamicRows.forEach(row => row.remove());
            
            // æ·»åŠ å·²æ ¸å‡†çš„è«‹è³¼å–®
            approvedProcurements.forEach(procurement => {
                const row = document.createElement('tr');
                row.setAttribute('data-dynamic', 'true');
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" 
                               class="approved-checkbox" 
                               data-procurement-id="${procurement.procurementNo}"
                               onchange="updateSelectedCount()">
                    </td>
                    <td>${procurement.procurementNo}</td>
                    <td>${procurement.applyDate}</td>
                    <td>${procurement.department}</td>
                    <td>${procurement.applicantName}</td>
                    <td style="text-align: right; font-weight: bold;">NT$ ${procurement.totalAmount.toLocaleString()}</td>
                    <td>${procurement.approver}</td>
                    <td>${procurement.approveTime}</td>
                    <td>
                        <button class="btn btn-primary" onclick="downloadDocument('${procurement.procurementNo}')">ğŸ’¾ ä¸‹è¼‰</button>
                        <button class="btn btn-secondary" onclick="viewDocument('${procurement.procurementNo}')">ğŸ‘ï¸ æŸ¥çœ‹</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // æ›´æ–°é¸æ“‡è¨ˆæ•¸
            updateSelectedCount();
        }

        // æ›´æ–°å·²é§å›è«‹è³¼å–®è¡¨æ ¼
        function updateRejectedProcurementTable() {
            const tableBody = document.getElementById('rejectedProcurementTable');
            
            // æ¸…ç©ºç¾æœ‰çš„å‹•æ…‹è³‡æ–™
            const dynamicRows = tableBody.querySelectorAll('tr[data-dynamic="true"]');
            dynamicRows.forEach(row => row.remove());
            
            // æ·»åŠ å·²é§å›çš„è«‹è³¼å–®
            rejectedProcurements.forEach(procurement => {
                const row = document.createElement('tr');
                row.setAttribute('data-dynamic', 'true');
                row.innerHTML = `
                    <td>${procurement.procurementNo}</td>
                    <td>${procurement.applyDate}</td>
                    <td>${procurement.department}</td>
                    <td>${procurement.applicantName}</td>
                    <td>${procurement.rejecter}</td>
                    <td>${procurement.rejectTime}</td>
                    <td>${procurement.rejectReason}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // æ›´æ–°é¸æ“‡è¨ˆæ•¸
        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.approved-checkbox:checked');
            const count = selectedCheckboxes.length;
            const totalCheckboxes = document.querySelectorAll('.approved-checkbox');
            
            // æ›´æ–°è¨ˆæ•¸é¡¯ç¤º
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = count;
            }
            
            // æ›´æ–°é¸æ“‡è³‡è¨Š
            const infoElement = document.getElementById('selectionInfo');
            if (infoElement) {
                if (count === 0) {
                    infoElement.textContent = 'è«‹å‹¾é¸è¦å»ºç«‹æ¡è³¼å–®çš„è«‹è³¼é …ç›®ï¼Œå¯ä»¥å¤šé¸';
                    infoElement.style.color = '#666';
                } else {
                    const totalAmount = calculateSelectedTotal();
                    infoElement.innerHTML = `å·²é¸æ“‡ <strong>${count}</strong> å€‹è«‹è³¼å–®ï¼Œç¸½é‡‘é¡ï¼š<strong>NT$ ${totalAmount.toLocaleString()}</strong>`;
                    infoElement.style.color = '#28a745';
                }
            }
            
            // æ›´æ–°å…¨é¸æ¡†ç‹€æ…‹
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox && totalCheckboxes.length > 0) {
                if (count === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (count === totalCheckboxes.length) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                }
            }
        }

        // è¨ˆç®—é¸æ“‡é …ç›®çš„ç¸½é‡‘é¡
        function calculateSelectedTotal() {
            const selectedCheckboxes = document.querySelectorAll('.approved-checkbox:checked');
            let total = 0;
            
            selectedCheckboxes.forEach(checkbox => {
                const procurementId = checkbox.getAttribute('data-procurement-id');
                const procurement = approvedProcurements.find(p => p.procurementNo === procurementId);
                if (procurement) {
                    total += procurement.totalAmount;
                }
            });
            
            return total;
        }

        // åˆ‡æ›å…¨é¸ç‹€æ…‹
        function toggleAllApproved() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.approved-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }

        // å…¨é¸å·²æ ¸å‡†é …ç›®
        function selectAllApproved() {
            const checkboxes = document.querySelectorAll('.approved-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            checkboxes.forEach(checkbox => checkbox.checked = true);
            if (selectAllCheckbox) selectAllCheckbox.checked = true;
            
            updateSelectedCount();
        }

        // æ¸…é™¤æ‰€æœ‰é¸æ“‡
        function clearAllApproved() {
            const checkboxes = document.querySelectorAll('.approved-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            checkboxes.forEach(checkbox => checkbox.checked = false);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            
            updateSelectedCount();
        }

        // é è¦½é¸æ“‡çš„é …ç›®
        function previewSelectedItems() {
            const selectedCheckboxes = document.querySelectorAll('.approved-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è¦é è¦½çš„è«‹è³¼å–®');
                return;
            }
            
            const selectedProcurements = [];
            selectedCheckboxes.forEach(checkbox => {
                const procurementId = checkbox.getAttribute('data-procurement-id');
                const procurement = approvedProcurements.find(p => p.procurementNo === procurementId);
                if (procurement) {
                    selectedProcurements.push(procurement);
                }
            });
            
            let previewContent = `
                <h3>é è¦½é¸æ“‡çš„è«‹è³¼å–® (${selectedProcurements.length} ç­†)</h3>
                <div style="margin-bottom: 20px;">
                    <strong>ç¸½é‡‘é¡ï¼šNT$ ${calculateSelectedTotal().toLocaleString()}</strong>
                </div>
            `;
            
            selectedProcurements.forEach((procurement, index) => {
                previewContent += `
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                        <h4>${index + 1}. ${procurement.procurementNo} - ${procurement.department}</h4>
                        <p><strong>ç”³è«‹äººï¼š</strong>${procurement.applicantName} | <strong>ç”³è«‹æ—¥æœŸï¼š</strong>${procurement.applyDate}</p>
                        <p><strong>é‡‘é¡ï¼š</strong>NT$ ${procurement.totalAmount.toLocaleString()}</p>
                        <p><strong>å“é …æ•¸é‡ï¼š</strong>${procurement.items.length} é …</p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #667eea;">æŸ¥çœ‹å“é …æ˜ç´°</summary>
                            <ul style="margin-top: 10px;">
                                ${procurement.items.map(item => `
                                    <li>${item.itemName} - ${item.quantity} ${item.unit} Ã— NT$ ${item.unitPrice} = NT$ ${item.subtotal.toLocaleString()}</li>
                                `).join('')}
                            </ul>
                        </details>
                    </div>
                `;
            });
            
            document.getElementById('modalTitle').textContent = 'é è¦½é¸æ“‡é …ç›®';
            document.getElementById('modalContent').innerHTML = previewContent;
            document.getElementById('viewModal').style.display = 'block';
        }

        // å¾å‹¾é¸é …ç›®å»ºç«‹æ¡è³¼å–®
        function createPurchaseFromSelected() {
            const selectedCheckboxes = document.querySelectorAll('.approved-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å·²æ ¸å‡†çš„è«‹è³¼å–®');
                return;
            }
            
            const selectedProcurements = [];
            selectedCheckboxes.forEach(checkbox => {
                const procurementId = checkbox.getAttribute('data-procurement-id');
                const procurement = approvedProcurements.find(p => p.procurementNo === procurementId);
                if (procurement) {
                    selectedProcurements.push(procurement);
                }
            });
            
            if (selectedProcurements.length === 0) {
                alert('æ‰¾ä¸åˆ°é¸æ“‡çš„è«‹è³¼å–®è³‡æ–™');
                return;
            }
            
            // åˆ‡æ›åˆ°å»ºç«‹æ¡è³¼å–®é é¢
            showPage('createPurchase');
            
            // æ¸…ç©ºç¾æœ‰çš„æ¡è³¼å“é …
            document.getElementById('purchaseItemsTableBody').innerHTML = '';
            purchaseItemCounter = 0;
            
            // å¡«å…¥é¸æ“‡çš„è«‹è³¼å–®å“é …
            selectedProcurements.forEach(procurement => {
                procurement.items.forEach(item => {
                    addPurchaseItemFromProcurement(item);
                });
            });
            
            // æ›´æ–°ç¸½é‡‘é¡
            updatePurchaseTotal();
            
            // é¡¯ç¤ºæç¤ºè¨Šæ¯
            showNotification(`å·²å¾ ${selectedProcurements.length} å€‹è«‹è³¼å–®åŒ¯å…¥ ${selectedProcurements.reduce((sum, p) => sum + p.items.length, 0)} å€‹å“é …`, 'success');
            
            // è¨­ç½®å‚™è¨»
            const noteField = document.getElementById('purchaseNote');
            noteField.value = `æ ¹æ“šä»¥ä¸‹è«‹è³¼å–®å»ºç«‹ï¼š${selectedProcurements.map(p => p.procurementNo).join(', ')}`;
        }

        // å¾è«‹è³¼å–®æ–°å¢æ¡è³¼å“é …
        function addPurchaseItemFromProcurement(procurementItem) {
            purchaseItemCounter++;
            const tableBody = document.getElementById('purchaseItemsTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" name="itemCode_${purchaseItemCounter}" value="${procurementItem.category}_${purchaseItemCounter.toString().padStart(3, '0')}" placeholder="å“é …ç·¨è™Ÿ"></td>
                <td><input type="text" name="purchaseItemName_${purchaseItemCounter}" value="${procurementItem.itemName}" placeholder="å“é …åç¨±"></td>
                <td><input type="text" name="purchaseSpec_${purchaseItemCounter}" value="${procurementItem.specification || ''}" placeholder="è¦æ ¼"></td>
                <td><input type="number" name="purchaseQuantity_${purchaseItemCounter}" value="${procurementItem.quantity}" placeholder="æ•¸é‡" onchange="updatePurchaseTotal()"></td>
                <td>
                    <select name="purchaseUnit_${purchaseItemCounter}">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ç›’" ${procurementItem.unit === 'ç›’' ? 'selected' : ''}>ç›’</option>
                        <option value="ç“¶" ${procurementItem.unit === 'ç“¶' ? 'selected' : ''}>ç“¶</option>
                        <option value="æ”¯" ${procurementItem.unit === 'æ”¯' ? 'selected' : ''}>æ”¯</option>
                        <option value="å€‹" ${procurementItem.unit === 'å€‹' ? 'selected' : ''}>å€‹</option>
                        <option value="åŒ…" ${procurementItem.unit === 'åŒ…' ? 'selected' : ''}>åŒ…</option>
                        <option value="å°" ${procurementItem.unit === 'å°' ? 'selected' : ''}>å°</option>
                    </select>
                </td>
                <td><input type="number" name="purchaseUnitPrice_${purchaseItemCounter}" value="${procurementItem.unitPrice}" placeholder="å–®åƒ¹" onchange="updatePurchaseTotal()"></td>
                <td class="purchase-subtotal">${(procurementItem.quantity * procurementItem.unitPrice).toLocaleString()}</td>
                <td><button type="button" class="btn btn-danger" onclick="removePurchaseItem(this)">ğŸ—‘ï¸</button></td>
            `;
            tableBody.appendChild(row);
        }

        // æ–°å¢æ¡è³¼å“é …
        function addPurchaseItem() {
            purchaseItemCounter++;
            const tableBody = document.getElementById('purchaseItemsTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" name="itemCode_${purchaseItemCounter}" placeholder="å“é …ç·¨è™Ÿ"></td>
                <td><input type="text" name="purchaseItemName_${purchaseItemCounter}" placeholder="å“é …åç¨±"></td>
                <td><input type="text" name="purchaseSpec_${purchaseItemCounter}" placeholder="è¦æ ¼"></td>
                <td><input type="number" name="purchaseQuantity_${purchaseItemCounter}" placeholder="æ•¸é‡" onchange="updatePurchaseTotal()"></td>
                <td>
                    <select name="purchaseUnit_${purchaseItemCounter}">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ç›’">ç›’</option>
                        <option value="ç“¶">ç“¶</option>
                        <option value="æ”¯">æ”¯</option>
                        <option value="å€‹">å€‹</option>
                        <option value="åŒ…">åŒ…</option>
                        <option value="å°">å°</option>
                    </select>
                </td>
                <td><input type="number" name="purchaseUnitPrice_${purchaseItemCounter}" placeholder="å–®åƒ¹" onchange="updatePurchaseTotal()"></td>
                <td class="purchase-subtotal">0</td>
                <td><button type="button" class="btn btn-danger" onclick="removePurchaseItem(this)">ğŸ—‘ï¸</button></td>
            `;
            tableBody.appendChild(row);
        }

        // ç§»é™¤æ¡è³¼å“é …
        function removePurchaseItem(button) {
            button.closest('tr').remove();
            updatePurchaseTotal();
        }

        // æ›´æ–°æ¡è³¼ç¸½é‡‘é¡
        function updatePurchaseTotal() {
            let total = 0;
            const tableBody = document.getElementById('purchaseItemsTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('input[name^="purchaseQuantity"]').value) || 0;
                const unitPrice = parseFloat(row.querySelector('input[name^="purchaseUnitPrice"]').value) || 0;
                const subtotal = quantity * unitPrice;
                
                row.querySelector('.purchase-subtotal').textContent = subtotal.toLocaleString();
                total += subtotal;
            });
            
            document.getElementById('purchaseTotalAmount').textContent = total.toLocaleString();
        }

        // æäº¤æ¡è³¼å–®
        function submitPurchase() {
            const purchaseNo = document.getElementById('purchaseNo').value;
            const purchaseDate = document.getElementById('purchaseDate').value;
            const supplier = document.getElementById('supplier').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const purchaseNote = document.getElementById('purchaseNote').value;
            
            if (!supplier) {
                alert('è«‹é¸æ“‡ä¾›æ‡‰å•†');
                return;
            }
            
            if (!contactPerson) {
                alert('è«‹å¡«å¯«è¯çµ¡äºº');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å“é …
            const tableBody = document.getElementById('purchaseItemsTableBody');
            if (tableBody.children.length === 0) {
                alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹å“é …');
                return;
            }
            
            // é©—è­‰å“é …è³‡æ–™ä¸¦æ”¶é›†å“é …è³‡è¨Š
            let isValid = true;
            let items = [];
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach((row, index) => {
                const itemCode = row.querySelector('input[name^="itemCode"]').value;
                const itemName = row.querySelector('input[name^="purchaseItemName"]').value;
                const specification = row.querySelector('input[name^="purchaseSpec"]').value;
                const quantity = row.querySelector('input[name^="purchaseQuantity"]').value;
                const unit = row.querySelector('select[name^="purchaseUnit"]').value;
                const unitPrice = row.querySelector('input[name^="purchaseUnitPrice"]').value;
                
                if (!itemCode || !itemName || !quantity || !unit) {
                    alert(`ç¬¬ ${index + 1} å€‹å“é …è³‡æ–™ä¸å®Œæ•´`);
                    isValid = false;
                    return;
                }
                
                items.push({
                    itemCode,
                    itemName,
                    specification,
                    quantity: parseInt(quantity),
                    unit,
                    unitPrice: parseFloat(unitPrice) || 0,
                    subtotal: (parseInt(quantity) * (parseFloat(unitPrice) || 0))
                });
            });
            
            if (!isValid) return;
            
            // è¨ˆç®—ç¸½é‡‘é¡
            const totalAmount = items.reduce((sum, item) => sum + item.subtotal, 0);
            
            // å‰µå»ºæ–°çš„æ¡è³¼å–®ç‰©ä»¶
            const newPurchase = {
                purchaseNo,
                purchaseDate,
                supplier,
                contactPerson,
                purchaseNote,
                items,
                totalAmount,
                status: 'å¾…å¯©æ ¸',
                submitTime: new Date().toLocaleString('zh-TW')
            };
            
            // åŠ å…¥åˆ°å¾…å¯©æ ¸åˆ—è¡¨
            pendingPurchases.push(newPurchase);
            
            // æ›´æ–°ç°½æ ¸ç®¡ç†é é¢çš„è¡¨æ ¼
            updatePendingPurchaseTable();
            
            // æäº¤æˆåŠŸ
            showNotification('æ¡è³¼å–®æäº¤æˆåŠŸï¼', 'success');
            resetPurchaseForm();
            
            // æ›´æ–°å¾…å¯©æ ¸æ•¸é‡
            updatePendingCount();
            
            console.log('æ–°æ¡è³¼å–®å·²åŠ å…¥:', newPurchase);
        }

        // é‡è¨­æ¡è³¼è¡¨å–®
        function resetPurchaseForm() {
            document.getElementById('purchaseForm').reset();
            document.getElementById('purchaseItemsTableBody').innerHTML = '';
            document.getElementById('purchaseTotalAmount').textContent = '0';
            generatePurchaseNo();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseDate').value = today;
            purchaseItemCounter = 0;
        }

        // æ–°å¢åº«å­˜å“é …
        function addInventoryItem() {
            editingInventoryItem = null;
            document.getElementById('inventoryModalTitle').textContent = 'æ–°å¢åº«å­˜å“é …';
            document.getElementById('inventoryEditForm').reset();
            
            // è‡ªå‹•ç”Ÿæˆå“é …ç·¨è™Ÿ
            const newCode = 'ITM' + (inventoryData.length + 1).toString().padStart(3, '0');
            document.getElementById('editItemCode').value = newCode;
            document.getElementById('editItemCode').readOnly = false;
            
            document.getElementById('inventoryEditModal').style.display = 'block';
        }

        // ç·¨è¼¯åº«å­˜å“é …
        function editInventoryItem(itemCode) {
            const item = inventoryData.find(i => i.itemCode === itemCode);
            if (!item) return;
            
            editingInventoryItem = itemCode;
            document.getElementById('inventoryModalTitle').textContent = 'ç·¨è¼¯åº«å­˜å“é …';
            
            document.getElementById('editItemCode').value = item.itemCode;
            document.getElementById('editItemCode').readOnly = true;
            document.getElementById('editItemName').value = item.itemName;
            document.getElementById('editCategory').value = item.category;
            document.getElementById('editSpecification').value = item.specification;
            document.getElementById('editCurrentStock').value = item.currentStock;
            document.getElementById('editSafetyStock').value = item.safetyStock;
            document.getElementById('editUnit').value = item.unit;
            
            document.getElementById('inventoryEditModal').style.display = 'block';
        }

        // ä¿å­˜åº«å­˜å“é …
        function saveInventoryItem() {
            const itemCode = document.getElementById('editItemCode').value;
            const itemName = document.getElementById('editItemName').value;
            const category = document.getElementById('editCategory').value;
            const specification = document.getElementById('editSpecification').value;
            const currentStock = parseInt(document.getElementById('editCurrentStock').value);
            const safetyStock = parseInt(document.getElementById('editSafetyStock').value);
            const unit = document.getElementById('editUnit').value;
            
            if (!itemCode || !itemName || !category || !unit || isNaN(currentStock) || isNaN(safetyStock)) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }
            
            const itemData = {
                itemCode,
                itemName,
                category,
                specification,
                currentStock,
                safetyStock,
                unit,
                lastUpdate: new Date().toISOString().split('T')[0]
            };
            
            if (editingInventoryItem) {
                // ç·¨è¼¯ç¾æœ‰å“é …
                const index = inventoryData.findIndex(i => i.itemCode === editingInventoryItem);
                if (index > -1) {
                    inventoryData[index] = itemData;
                    showNotification(`åº«å­˜å“é … ${itemCode} å·²æ›´æ–°`, 'success');
                }
            } else {
                // æ–°å¢å“é …
                inventoryData.push(itemData);
                showNotification(`åº«å­˜å“é … ${itemCode} å·²æ–°å¢`, 'success');
            }
            
            updateInventoryTable();
            refreshInventoryStats();
            closeModal('inventoryEditModal');
        }

        // åˆªé™¤åº«å­˜å“é …
        function deleteInventoryItem(itemCode) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤åº«å­˜å“é … ${itemCode} å—ï¼Ÿ`)) {
                const index = inventoryData.findIndex(i => i.itemCode === itemCode);
                if (index > -1) {
                    inventoryData.splice(index, 1);
                    updateInventoryTable();
                    refreshInventoryStats();
                    showNotification(`åº«å­˜å“é … ${itemCode} å·²åˆªé™¤`, 'success');
                }
            }
        }

        // åº«å­˜æœå°‹
        function searchInventory(keyword) {
            const table = document.getElementById('inventoryTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                
                if (text.includes(keyword.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // ä¸‹è¼‰åº«å­˜æ¸…å–®
        function downloadInventoryList() {
            if (inventoryData.length === 0) {
                alert('ç›®å‰æ²’æœ‰åº«å­˜è³‡æ–™å¯ä¸‹è¼‰');
                return;
            }
            
            showNotification('æ­£åœ¨ç”Ÿæˆåº«å­˜æ¸…å–®...', 'success');
            
            // ç”ŸæˆCSVæ ¼å¼çš„åº«å­˜æ¸…å–®
            let csvContent = 'å“é …ç·¨è™Ÿ,å“é …åç¨±,é¡åˆ¥,è¦æ ¼,ç¾æœ‰åº«å­˜,å®‰å…¨åº«å­˜,å–®ä½,ç‹€æ…‹,æœ€å¾Œæ›´æ–°\n';
            
            inventoryData.forEach(item => {
                const status = getInventoryStatus(item);
                csvContent += `"${item.itemCode}","${item.itemName}","${item.category}","${item.specification}",${item.currentStock},${item.safetyStock},"${item.unit}","${status}","${item.lastUpdate}"\n`;
            });
            
            // å‰µå»ºä¸¦ä¸‹è¼‰æ–‡ä»¶
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åº«å­˜æ¸…å–®_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            setTimeout(() => {
                showNotification('åº«å­˜æ¸…å–®ä¸‹è¼‰å®Œæˆ', 'success');
            }, 1000);
        }

        // ä¸‹è¼‰æ–‡ä»¶
        function downloadDocument(docId) {
            showNotification(`æ­£åœ¨ç”Ÿæˆ ${docId} PDFæª”æ¡ˆ...`, 'success');
            
            // å°‹æ‰¾æ–‡ä»¶è³‡æ–™
            let documentData = null;
            documentData = pendingProcurements.find(proc => proc.procurementNo === docId) ||
                          approvedProcurements.find(proc => proc.procurementNo === docId) ||
                          rejectedProcurements.find(proc => proc.procurementNo === docId);
            
            if (documentData) {
                // ç”ŸæˆçœŸå¯¦çš„PDFå…§å®¹
                generatePDF(documentData, 'procurement');
            } else {
                // ç”Ÿæˆç¤ºä¾‹PDF
                generateSamplePDF(docId);
            }
        }

        // ç”ŸæˆPDFæ–‡ä»¶
        function generatePDF(data, type) {
            const pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${type === 'procurement' ? 'è«‹è³¼å–®' : 'æ¡è³¼å–®'}</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; line-height: 1.5; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .info-table td { padding: 10px; border: 1px solid #ddd; }
        .items-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .items-table th, .items-table td { padding: 10px; border: 1px solid #333; text-align: center; }
        .items-table th { background-color: #f0f0f0; font-weight: bold; }
        .items-table .text-left { text-align: left; }
        .items-table .text-right { text-align: right; }
        .subtotal-row { background-color: #f8f9fa; }
        .total-section { margin-top: 30px; border: 2px solid #333; padding: 20px; background-color: #f8f9fa; }
        .total-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd; }
        .total-row.final { border-bottom: 2px solid #333; font-size: 18px; font-weight: bold; color: #d73527; }
        .status { color: ${data.status === 'å·²æ ¸å‡†' ? 'green' : data.status === 'å·²é§å›' ? 'red' : 'orange'}; }
        .signature-section { margin-top: 40px; display: flex; justify-content: space-between; }
        .signature-box { width: 30%; text-align: center; border: 1px solid #ddd; padding: 30px 10px; }
        .page-footer { margin-top: 50px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¥ ä¸Šå‰é†«ç™‚ - ${type === 'procurement' ? 'è«‹è³¼å–®' : 'æ¡è³¼å–®'}</h1>
        <h2 style="color: #333; margin-top: 10px;">${data.procurementNo || data.purchaseNo}</h2>
    </div>
    
    <table class="info-table">
        <tr>
            <td style="background-color: #f0f0f0; font-weight: bold; width: 15%;"><strong>${type === 'procurement' ? 'è«‹è³¼å–®è™Ÿ' : 'æ¡è³¼å–®è™Ÿ'}</strong></td>
            <td style="width: 35%;">${data.procurementNo || data.purchaseNo}</td>
            <td style="background-color: #f0f0f0; font-weight: bold; width: 15%;"><strong>${type === 'procurement' ? 'ç”³è«‹æ—¥æœŸ' : 'æ¡è³¼æ—¥æœŸ'}</strong></td>
            <td style="width: 35%;">${data.applyDate || data.purchaseDate}</td>
        </tr>
        <tr>
            <td style="background-color: #f0f0f0; font-weight: bold;"><strong>${type === 'procurement' ? 'ç”³è«‹éƒ¨é–€' : 'ä¾›æ‡‰å•†'}</strong></td>
            <td>${data.department || data.supplier}</td>
            <td style="background-color: #f0f0f0; font-weight: bold;"><strong>${type === 'procurement' ? 'ç”³è«‹äºº' : 'è¯çµ¡äºº'}</strong></td>
            <td>${data.applicantName || data.contactPerson}</td>
        </tr>
        <tr>
            <td style="background-color: #f0f0f0; font-weight: bold;"><strong>${type === 'procurement' ? 'è«‹è³¼äº‹ç”±' : 'å‚™è¨»'}</strong></td>
            <td colspan="3">${data.procurementReason || data.purchaseNote || ''}</td>
        </tr>
        <tr>
            <td style="background-color: #f0f0f0; font-weight: bold;"><strong>ç‹€æ…‹</strong></td>
            <td><span class="status" style="font-weight: bold;">${data.status}</span></td>
            <td style="background-color: #f0f0f0; font-weight: bold;"><strong>æäº¤æ™‚é–“</strong></td>
            <td>${data.submitTime}</td>
        </tr>
    </table>
    
            <h3 style="margin-top: 30px; color: #333;">${type === 'procurement' ? 'è«‹è³¼å“é …æ˜ç´°' : 'æ¡è³¼å“é …æ˜ç´°'}</h3>
    <table class="items-table">
        <thead>
            <tr>
                <th style="width: 8%;">é …æ¬¡</th>
                <th style="width: 15%;">${type === 'procurement' ? 'é¡åˆ¥' : 'å“é …ç·¨è™Ÿ'}</th>
                <th style="width: 25%;">å“é …åç¨±</th>
                <th style="width: 20%;">è¦æ ¼</th>
                <th style="width: 8%;">æ•¸é‡</th>
                <th style="width: 8%;">å–®ä½</th>
                <th style="width: 12%;">å–®åƒ¹</th>
                <th style="width: 12%;">å°è¨ˆ</th>
            </tr>
        </thead>
        <tbody>
            ${data.items.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td class="text-left">${item.category || item.itemCode || ''}</td>
                    <td class="text-left">${item.itemName}</td>
                    <td class="text-left">${item.specification || '-'}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td class="text-right">${item.unitPrice.toLocaleString()}</td>
                    <td class="text-right">${item.subtotal.toLocaleString()}</td>
                </tr>
            `).join('')}
            <tr class="subtotal-row">
                <td colspan="6" style="text-align: right; font-weight: bold; padding: 15px;">å“é …å°è¨ˆï¼š</td>
                <td style="text-align: right; font-weight: bold;">å…± ${data.items.length} é …</td>
                <td style="text-align: right; font-weight: bold; color: #d73527;">${data.items.reduce((sum, item) => sum + item.subtotal, 0).toLocaleString()}</td>
            </tr>
        </tbody>
    </table>
    
    <div class="total-section">
        <h3 style="margin-top: 0; color: #333; text-align: center;">ğŸ’° é‡‘é¡ç¸½è¨ˆ</h3>
        <div class="total-row">
            <span>å“é …ç¸½è¨ˆï¼š</span>
            <span>NT$ ${data.items.reduce((sum, item) => sum + item.subtotal, 0).toLocaleString()}</span>
        </div>
        <div class="total-row">
            <span>ç¨…é¡ (5%)ï¼š</span>
            <span>NT$ ${Math.round(data.items.reduce((sum, item) => sum + item.subtotal, 0) * 0.05).toLocaleString()}</span>
        </div>
        <div class="total-row final">
            <span>ç¸½è¨ˆé‡‘é¡ï¼š</span>
            <span>NT$ ${Math.round(data.items.reduce((sum, item) => sum + item.subtotal, 0) * 1.05).toLocaleString()}</span>
        </div>
        <div style="margin-top: 15px; text-align: center; font-size: 14px; color: #666;">
            (å«ç¨…ç¸½é¡)
        </div>
    </div>
    
    ${data.approver ? `
    <div style="margin-top: 30px; border: 1px solid #ddd; padding: 20px; background-color: #e8f5e8;">
        <h4 style="color: green; margin-top: 0;">âœ… æ ¸å‡†è³‡è¨Š</h4>
        <p><strong>æ ¸å‡†äººï¼š</strong>${data.approver}</p>
        <p><strong>æ ¸å‡†æ™‚é–“ï¼š</strong>${data.approveTime}</p>
        <p style="margin-bottom: 0;"><strong>å‚™è¨»ï¼š</strong>æ­¤${type === 'procurement' ? 'è«‹è³¼å–®' : 'æ¡è³¼å–®'}å·²é€šéå¯©æ ¸</p>
    </div>` : ''}
    
    ${data.rejecter ? `
    <div style="margin-top: 30px; border: 1px solid #ddd; padding: 20px; background-color: #fdeaea;">
        <h4 style="color: red; margin-top: 0;">âŒ é§å›è³‡è¨Š</h4>
        <p><strong>é§å›äººï¼š</strong>${data.rejecter}</p>
        <p><strong>é§å›æ™‚é–“ï¼š</strong>${data.rejectTime}</p>
        <p style="margin-bottom: 0;"><strong>é§å›åŸå› ï¼š</strong>${data.rejectReason}</p>
    </div>` : ''}
    
    <div class="signature-section">
        <div class="signature-box">
            <div style="font-weight: bold; margin-bottom: 20px;">${type === 'procurement' ? 'ç”³è«‹äººç°½å' : 'æ¡è³¼äººå“¡ç°½å'}</div>
            <div style="height: 40px;"></div>
            <div style="border-top: 1px solid #333; margin-top: 10px;">æ—¥æœŸï¼š_______</div>
        </div>
        <div class="signature-box">
            <div style="font-weight: bold; margin-bottom: 20px;">éƒ¨é–€ä¸»ç®¡ç°½å</div>
            <div style="height: 40px;"></div>
            <div style="border-top: 1px solid #333; margin-top: 10px;">æ—¥æœŸï¼š_______</div>
        </div>
        <div class="signature-box">
            <div style="font-weight: bold; margin-bottom: 20px;">æ¡è³¼ä¸»ç®¡ç°½å</div>
            <div style="height: 40px;"></div>
            <div style="border-top: 1px solid #333; margin-top: 10px;">æ—¥æœŸï¼š_______</div>
        </div>
    </div>
    
    <div class="page-footer">
        <p><strong>ä¸Šå‰é†«ç™‚è—¥å“é†«æè«‹è³¼ç³»çµ±</strong></p>
        <p>ğŸ“§ è¯çµ¡é›»è©±ï¼š(02) 1234-5678 | ğŸ“§ Email: procurement@shangi-medical.com</p>
        <p>ğŸ•’ æ–‡ä»¶ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}</p>
        <p style="font-size: 10px; margin-top: 10px;">æœ¬æ–‡ä»¶ç”±ç³»çµ±è‡ªå‹•ç”Ÿæˆï¼Œå¦‚æœ‰ç–‘å•è«‹è¯ç¹«è³‡è¨Šéƒ¨é–€</p>
    </div>
</body>
</html>`;

            // å‰µå»ºä¸¦ä¸‹è¼‰PDF
            const blob = new Blob([pdfContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.procurementNo || data.purchaseNo}_${type === 'procurement' ? 'è«‹è³¼å–®' : 'æ¡è³¼å–®'}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            setTimeout(() => {
                showNotification(`${data.procurementNo || data.purchaseNo} ä¸‹è¼‰å®Œæˆ`, 'success');
            }, 1000);
        }

        // ç”Ÿæˆç¤ºä¾‹PDF
        function generateSamplePDF(docId) {
            const sampleData = {
                procurementNo: docId,
                applyDate: '2025-07-24',
                department: 'ç¤ºä¾‹éƒ¨é–€',
                applicantName: 'ç¤ºä¾‹ç”³è«‹äºº',
                procurementReason: 'ç¤ºä¾‹è«‹è³¼äº‹ç”±',
                status: 'å¾…å¯©æ ¸',
                submitTime: new Date().toLocaleString('zh-TW'),
                items: [
                    {
                        category: 'é†«æ',
                        itemName: 'è¡€å£“è¨ˆ',
                        specification: 'é›»å­å¼',
                        quantity: 2,
                        unit: 'å°',
                        unitPrice: 1500,
                        subtotal: 3000
                    },
                    {
                        category: 'è—¥å“',
                        itemName: 'é˜¿æ–¯åŒ¹éˆ',
                        specification: '100mg',
                        quantity: 5,
                        unit: 'ç›’',
                        unitPrice: 200,
                        subtotal: 1000
                    }
                ],
                totalAmount: 4000
            };
            generatePDF(sampleData, 'procurement');
        }

        // ä¸‹è¼‰æ‰€æœ‰å·²æ ¸å‡†æ–‡ä»¶
        function downloadAllApproved() {
            if (confirm('ç¢ºå®šè¦ä¸‹è¼‰æ‰€æœ‰å·²æ ¸å‡†çš„è«‹è³¼å–®å—ï¼Ÿ')) {
                showNotification('æ­£åœ¨æ‰“åŒ…ä¸‹è¼‰æ‰€æœ‰å·²æ ¸å‡†æ–‡ä»¶...', 'success');
                
                if (approvedProcurements.length === 0) {
                    alert('ç›®å‰æ²’æœ‰å·²æ ¸å‡†çš„è«‹è³¼å–®');
                    return;
                }
                
                // ç”Ÿæˆåˆä½µçš„HTMLæ–‡ä»¶
                let combinedContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å·²æ ¸å‡†è«‹è³¼å–®åŒ¯ç¸½</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; }
        .header { text-align: center; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        .document { margin-bottom: 50px; page-break-after: always; }
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .info-table td { padding: 8px; border: 1px solid #ddd; }
        .items-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .items-table th, .items-table td { padding: 10px; border: 1px solid #333; text-align: center; }
        .items-table th { background-color: #f0f0f0; }
        .total { text-align: right; margin-top: 20px; font-size: 18px; font-weight: bold; }
        .summary { background-color: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¥ ä¸Šå‰é†«ç™‚ - å·²æ ¸å‡†è«‹è³¼å–®åŒ¯ç¸½</h1>
        <p>åŒ¯ç¸½æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}</p>
        <p>å…± ${approvedProcurements.length} ç­†å·²æ ¸å‡†è«‹è³¼å–®</p>
    </div>
    
    <div class="summary">
        <h2>ğŸ“Š åŒ¯ç¸½çµ±è¨ˆ</h2>
        <p><strong>ç¸½ç­†æ•¸ï¼š</strong>${approvedProcurements.length} ç­†</p>
        <p><strong>ç¸½é‡‘é¡ï¼š</strong>NT$ ${approvedProcurements.reduce((sum, proc) => sum + proc.totalAmount, 0).toLocaleString()}</p>
        <p><strong>æ ¸å‡†æœŸé–“ï¼š</strong>${approvedProcurements.length > 0 ? approvedProcurements[0].approveTime + ' ~ ' + approvedProcurements[approvedProcurements.length - 1].approveTime : 'N/A'}</p>
    </div>
    
    ${approvedProcurements.map((data, index) => `
    <div class="document">
        <h2>è«‹è³¼å–® ${index + 1} - ${data.procurementNo}</h2>
        
        <table class="info-table">
            <tr>
                <td><strong>è«‹è³¼å–®è™Ÿ</strong></td>
                <td>${data.procurementNo}</td>
                <td><strong>ç”³è«‹æ—¥æœŸ</strong></td>
                <td>${data.applyDate}</td>
            </tr>
            <tr>
                <td><strong>ç”³è«‹éƒ¨é–€</strong></td>
                <td>${data.department}</td>
                <td><strong>ç”³è«‹äºº</strong></td>
                <td>${data.applicantName}</td>
            </tr>
            <tr>
                <td><strong>è«‹è³¼äº‹ç”±</strong></td>
                <td colspan="3">${data.procurementReason}</td>
            </tr>
            <tr>
                <td><strong>æ ¸å‡†äºº</strong></td>
                <td>${data.approver}</td>
                <td><strong>æ ¸å‡†æ™‚é–“</strong></td>
                <td>${data.approveTime}</td>
            </tr>
        </table>
        
        <h3>è«‹è³¼å“é …</h3>
        <table class="items-table">
            <thead>
                <tr>
                    <th>é …æ¬¡</th>
                    <th>é¡åˆ¥</th>
                    <th>åç¨±</th>
                    <th>è¦æ ¼</th>
                    <th>æ•¸é‡</th>
                    <th>å–®ä½</th>
                    <th>å–®åƒ¹</th>
                    <th>å°è¨ˆ</th>
                </tr>
            </thead>
            <tbody>
                ${data.items.map((item, itemIndex) => `
                    <tr>
                        <td>${itemIndex + 1}</td>
                        <td>${item.category}</td>
                        <td>${item.itemName}</td>
                        <td>${item.specification || ''}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit}</td>
                        <td>NT$ ${item.unitPrice.toLocaleString()}</td>
                        <td>NT$ ${item.subtotal.toLocaleString()}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div class="total">
            ç¸½é‡‘é¡ï¼šNT$ ${data.totalAmount.toLocaleString()}
        </div>
    </div>
    `).join('')}
    
    <div style="text-align: center; color: #666; font-size: 12px; margin-top: 50px;">
        <p>æ­¤æ–‡ä»¶ç”±ä¸Šå‰é†«ç™‚è—¥å“é†«æè«‹è³¼ç³»çµ±è‡ªå‹•ç”Ÿæˆ</p>
        <p>åŒ…å«æ‰€æœ‰å·²æ ¸å‡†è«‹è³¼å–®çš„å®Œæ•´è³‡è¨Š</p>
    </div>
</body>
</html>`;

                // å‰µå»ºä¸¦ä¸‹è¼‰åˆä½µæ–‡ä»¶
                const blob = new Blob([combinedContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `å·²æ ¸å‡†è«‹è³¼å–®åŒ¯ç¸½_${new Date().toISOString().slice(0, 10)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    showNotification('æ‰€æœ‰æ–‡ä»¶ä¸‹è¼‰å®Œæˆ', 'success');
                }, 2000);
            }
        }

        // æ›´æ–°å¾…å¯©æ ¸æ•¸é‡
        function updatePendingCount() {
            const totalPending = pendingProcurements.length + pendingPurchases.length;
            const badgeElement = document.getElementById('pendingCount');
            if (badgeElement) {
                badgeElement.textContent = totalPending;
                
                // å¦‚æœæ²’æœ‰å¾…å¯©æ ¸é …ç›®ï¼Œéš±è—å¾½ç« 
                if (totalPending === 0) {
                    badgeElement.style.display = 'none';
                } else {
                    badgeElement.style.display = 'flex';
                }
            }
        }

        // ç³»çµ±ç®¡ç†åŠŸèƒ½
        function addUser() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const name = document.getElementById('adminName').value;
            const department = document.getElementById('adminDepartment').value;
            const role = document.getElementById('adminRole').value;
            
            if (!username || !password || !name || !department || !role) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }
            
            // æª¢æŸ¥å¸³è™Ÿæ˜¯å¦å·²å­˜åœ¨
            if (users[username]) {
                alert('æ­¤å¸³è™Ÿå·²å­˜åœ¨');
                return;
            }
            
            // æ–°å¢ä½¿ç”¨è€…åˆ°ç³»çµ±
            users[username] = password;
            
            // æ–°å¢åˆ°ä½¿ç”¨è€…è¡¨æ ¼
            const table = document.getElementById('userTable');
            const row = table.insertRow();
            const today = new Date().toISOString().split('T')[0];
            
            let roleClass = 'status-pending';
            if (role === 'ç®¡ç†è€…') roleClass = 'status-approved';
            else if (role === 'å¯©æ ¸è€…') roleClass = 'status-approved';
            
            row.innerHTML = `
                <td>${username}</td>
                <td>${name}</td>
                <td>${department}</td>
                <td><span class="status-badge ${roleClass}">${role}</span></td>
                <td>${today}</td>
                <td>
                    <button class="btn btn-primary" onclick="editUser('${username}')">âœï¸ ç·¨è¼¯</button>
                    <button class="btn btn-danger" onclick="deleteUser('${username}')">ğŸ—‘ï¸ åˆªé™¤</button>
                </td>
            `;
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('accountForm').reset();
            showNotification('ä½¿ç”¨è€…æ–°å¢æˆåŠŸ', 'success');
        }

        function editUser(username) {
            showNotification(`ç·¨è¼¯ä½¿ç”¨è€…åŠŸèƒ½é–‹ç™¼ä¸­ï¼š${username}`, 'success');
        }

        function deleteUser(username) {
            if (username === 'admin') {
                alert('ä¸èƒ½åˆªé™¤ç®¡ç†å“¡å¸³è™Ÿ');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ä½¿ç”¨è€… ${username} å—ï¼Ÿ`)) {
                delete users[username];
                showNotification(`ä½¿ç”¨è€… ${username} å·²åˆªé™¤`, 'success');
                location.reload();
            }
        }

        function addApprover() {
            const process = document.getElementById('approvalProcess').value;
            const order = document.getElementById('approvalOrder').value;
            const approver = document.getElementById('approverName').value;
            const limit = document.getElementById('amountLimit').value;
            
            if (!process || !order || !approver) {
                alert('è«‹å¡«å¯«å¿…è¦æ¬„ä½');
                return;
            }
            
            showNotification('ç°½æ ¸è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­', 'success');
        }

        function editApprover(id) {
            showNotification(`ç·¨è¼¯ç°½æ ¸è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­ï¼š${id}`, 'success');
        }

        function deleteApprover(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç°½æ ¸è¨­å®šå—ï¼Ÿ')) {
                showNotification('ç°½æ ¸è¨­å®šå·²åˆªé™¤', 'success');
            }
        }

        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            // å‰µå»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            
            document.body.appendChild(notification);
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // é»æ“Šå…¶ä»–åœ°æ–¹æ™‚é—œé–‰ä¸‹æ‹‰é¸å–®
        document.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-btn')) {
                const dropdowns = document.querySelectorAll('.dropdown-content');
                dropdowns.forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨æ™‚é—œé–‰
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Enteréµç™»å…¥
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const loginPage = document.getElementById('loginPage');
                if (loginPage && loginPage.style.display !== 'none') {
                    console.log('Enteréµè§¸ç™¼ç™»å…¥');
                    login();
                }
            }
        });

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.addEventListener('load', function() {
            console.log('é é¢å®Œå…¨è¼‰å…¥');
            
            // æ¨¡æ“¬æ¡Œé¢é€šçŸ¥ï¼ˆéœ€è¦ä½¿ç”¨è€…æˆæ¬Šï¼‰
            if ('Notification' in window) {
                Notification.requestPermission();
            }
            
            // æ¸¬è©¦ç™»å…¥æŒ‰éˆ•
            const loginBtn = document.querySelector('.login-btn');
            if (loginBtn) {
                console.log('ç™»å…¥æŒ‰éˆ•æ‰¾åˆ°');
                loginBtn.addEventListener('click', function() {
                    console.log('ç™»å…¥æŒ‰éˆ•è¢«é»æ“Š');
                    login();
                });
            } else {
                console.error('æ‰¾ä¸åˆ°ç™»å…¥æŒ‰éˆ•');
            }
        });

        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨åŸŸéŒ¯èª¤:', event.error);
            showNotification('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
        });

        // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ç•¶é»æ“Šä¸Šå‚³å€åŸŸæ™‚
        function clearFileInput() {
            document.getElementById('excelFile').value = '';
        }

        // ç‚ºä¸Šå‚³å€åŸŸæ·»åŠ é»æ“Šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const fileUpload = document.querySelector('.file-upload');
            if (fileUpload) {
                fileUpload.addEventListener('click', clearFileInput);
            }
        });
    </script>
</body>
</html>
